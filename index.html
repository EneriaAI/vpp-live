<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BESS v5 Tasuvusmudel ‚Äî Reaalne PEJ Graafik</title>
<style>
:root{--p:#2B5F2B;--a:#E8A838;--d:#1a1a1a;--bg:#f4f5f7;--c:#fff;--b:#ddd;--g:#1B7A1B;--r:#C0392B;--w:#D4870F;--bl:#1A5276}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:var(--d);font-size:13px;line-height:1.45}
.hdr{background:linear-gradient(135deg,var(--p),#1a3f1a);color:#fff;padding:18px 24px}
.hdr h1{font-size:18px}.hdr p{opacity:.7;font-size:11px;margin-top:3px}
.wrap{max-width:1440px;margin:0 auto;padding:12px}
.cols{display:grid;grid-template-columns:320px 1fr;gap:12px}
@media(max-width:960px){.cols{grid-template-columns:1fr}}
.pnl{background:var(--c);border:1px solid var(--b);border-radius:6px;padding:12px;margin-bottom:10px}
.pnl h2{font-size:12px;font-weight:700;color:var(--p);text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid var(--a);padding-bottom:4px;margin-bottom:8px}
.pnl h3{font-size:11px;font-weight:600;color:#555;margin:8px 0 4px}
.f{margin-bottom:6px}.f label{display:block;font-size:10px;color:#777;margin-bottom:1px;font-weight:500}
.f input,.f select{width:100%;padding:4px 6px;border:1px solid #ccc;border-radius:3px;font-size:12px}
.f input:focus{outline:none;border-color:var(--p)}
.r2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.r3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.tg{display:flex;align-items:center;gap:6px;margin:4px 0;font-size:11px}
.tg input{width:14px;height:14px;accent-color:var(--p)}
.btn{display:block;width:100%;padding:8px;background:var(--p);color:#fff;border:none;border-radius:4px;font-size:13px;font-weight:600;cursor:pointer;margin-top:8px}
.btn:hover{background:#1a3f1a}.btn2{background:var(--a)}.btn2:hover{background:#c78a2a}
.mg{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-bottom:10px}
.m{background:var(--c);border:1px solid var(--b);border-radius:6px;padding:10px;text-align:center}
.m .v{font-size:22px;font-weight:700}.m .l{font-size:10px;color:#888;text-transform:uppercase}.m .s{font-size:10px;color:#aaa}
.m.ok .v{color:var(--g)}.m.wa .v{color:var(--w)}.m.ba .v{color:var(--r)}
.tg2{display:inline-block;padding:1px 6px;border-radius:8px;font-size:9px;font-weight:600;margin-top:2px}
.tg2g{background:#e8f5e9;color:var(--g)}.tg2y{background:#fff8e1;color:var(--w)}.tg2r{background:#fce4ec;color:var(--r)}
table{width:100%;border-collapse:collapse;font-size:10px;margin-top:6px}
th{background:var(--p);color:#fff;padding:4px 6px;text-align:right;font-weight:600;font-size:10px}
th:first-child{text-align:left}td{padding:3px 6px;border-bottom:1px solid #eee;text-align:right}
td:first-child{text-align:left;font-weight:500}tr:nth-child(even){background:#f9f9f9}
.neg{color:var(--r)}
.tabs{display:flex;gap:3px;margin-bottom:8px;flex-wrap:wrap}
.tab{padding:4px 10px;border:1px solid var(--b);border-radius:4px 4px 0 0;font-size:11px;cursor:pointer;background:#f5f5f5;font-weight:500}
.tab.on{background:var(--c);border-bottom-color:var(--c);color:var(--p);font-weight:700}
.tc{display:none}.tc.on{display:block}
.inf{font-size:10px;color:#999;font-style:italic;margin-top:3px}
.bar{display:inline-block;height:10px;border-radius:2px;vertical-align:middle}
.imp{background:linear-gradient(135deg,#e8f5e9,#f1f8e9);border:1px solid #a5d6a7;border-radius:6px;padding:10px;margin-top:8px}
.imp h3{color:var(--g);font-size:12px;margin-bottom:4px}.imp p{font-size:11px;margin:2px 0}
.imp b{color:var(--g)}
canvas{width:100%!important;height:200px!important}
.chart-wrap{position:relative;height:220px;margin:8px 0}
</style>
</head>
<body>
<div class="hdr">
<h1>‚ö° BESS v5 Tasuvusmudel ‚Äî Reaalne PEJ Graafik HP260001</h1>
<p>Kaerap√µllu, Elva vald | PEJ 675 kWp / Inverter 500 kW | M√µ√µteandmed 2025 (15-min) | 604.8 MWh aastane toodang</p>
</div>
<div class="wrap"><div class="cols">
<!-- LEFT -->
<div>
<div class="pnl">
<h2>‚öôÔ∏è Konfiguratsioon</h2>
<div class="f"><label>Akupaigaldis</label>
<select id="cfg" onchange="lCfg()">
<option value="500">500 kW / 1028 kWh (4 tk)</option>
<option value="750">750 kW / 1542 kWh (6 tk)</option>
<option value="1000" selected>1000 kW / 2056 kWh (8 tk) ‚úì</option>
</select></div>
<div class="r2">
<div class="f"><label>BESS (kW)</label><input id="bP" type="number" value="1000"></div>
<div class="f"><label>BESS (kWh)</label><input id="bC" type="number" value="2056"></div>
</div>
<div class="r2">
<div class="f"><label>PEJ paneelid (kWp)</label><input id="pP" type="number" value="675"></div>
<div class="f"><label>Inverter (kW)</label><input id="iP" type="number" value="500"></div>
</div>
<div class="r2">
<div class="f"><label>V√µrgu liitumine (kW)</label><input id="gL" type="number" value="490"></div>
<div class="f"><label>CAPEX BESS+PEJ (‚Ç¨)</label><input id="cx" type="number" value="810380"></div>
</div>
<div class="f"><label>PEJ CAPEX (‚Ç¨)</label><input id="pc" type="number" value="337500"></div>
</div>

<div class="pnl">
<h2>üîã Aku parameetrid</h2>
<div class="r2">
<div class="f"><label>RTE (%)</label><input id="rt" type="number" value="91.3" step="0.1"></div>
<div class="f"><label>Alg. efekt. (%)</label><input id="ie" type="number" value="98"></div>
</div>
<div class="r2">
<div class="f"><label>Degradatsioon (%/a)</label><input id="dg" type="number" value="3" step="0.5"></div>
<div class="f"><label>Max ts√ºklid</label><input id="mc" type="number" value="10000"></div>
</div>
<div class="r2">
<div class="f"><label>Aku eluiga (a)</label><input id="bl" type="number" value="10"></div>
<div class="f"><label>Taristu eluiga (a)</label><input id="il" type="number" value="15"></div>
</div>
</div>

<div class="pnl">
<h2>üìä Finantssisendid</h2>
<div class="r2">
<div class="f"><label>WACC (%)</label><input id="wc" type="number" value="5" step="0.5"></div>
<div class="f"><label>Inflatsioon (%)</label><input id="if" type="number" value="2" step="0.5"></div>
</div>
<div class="r2">
<div class="f"><label>OPEX (‚Ç¨/MW/a)</label><input id="ox" type="number" value="15000"></div>
<div class="f"><label>VPP tasu (%)</label><input id="vf" type="number" value="10"></div>
</div>
<div class="f"><label>M√º√ºgimarginaal (‚Ç¨/MWh)</label><input id="mg" type="number" value="15"></div>
</div>

<div class="pnl">
<h2>üÜï v5 Optimeerimisloogika</h2>
<div class="tg"><input type="checkbox" id="eC" checked><label for="eC"><b>Clipping Capture</b></label></div>
<p class="inf">Reaalsed platootunnid: 165 h/a. Inverter piiratud ~489 kW, paneelid suudavad ~660 kW. √úlej√§√§k ~27.8 MWh/a akusse @ 0‚Ç¨.</p>

<div class="tg" style="margin-top:6px"><input type="checkbox" id="eD" checked><label for="eD"><b>Degradatsioonip√µhine arbitraa≈æ</b></label></div>
<div class="r2">
<div class="f"><label>Avg DoD (%)</label><input id="dd" type="number" value="80"></div>
<div class="f"><label>Arb. min spread (‚Ç¨/MWh)</label><input id="ms" type="number" value="0" readonly></div>
</div>
<p class="inf">Cost/ts√ºkkel arvutatakse automaatselt. Madala marginaaliga arbitraa≈æ filtreeritakse v√§lja.</p>

<div class="tg" style="margin-top:6px"><input type="checkbox" id="eF" checked><label for="eF"><b>FCR-D / aFRR eristamine</b></label></div>
<div class="r3">
<div class="f"><label>FCR-D (%)</label><input id="fs" type="number" value="40"></div>
<div class="f"><label>aFRR (%)</label><input id="as" type="number" value="35"></div>
<div class="f"><label>Arbitraa≈æ (%)</label><input id="bs" type="number" value="25"></div>
</div>
<div class="r2">
<div class="f"><label>FCR-D ts/p√§ev</label><input id="fc" type="number" value="0.1" step="0.1"></div>
<div class="f"><label>aFRR ts/p√§ev</label><input id="ac" type="number" value="1.5" step="0.1"></div>
</div>
</div>

<button class="btn" onclick="run()">‚ñ∂ ARVUTA v5 MUDEL</button>
<button class="btn btn2" style="margin-top:4px" onclick="cmp()">üìä v4 vs v5 V√ïRDLUS</button>
</div>

<!-- RIGHT -->
<div id="out">
<div class="pnl"><h2>üìà Reaalne PEJ toodang 2025</h2><div id="pvChart"></div></div>
<div class="pnl"><p style="color:#888;text-align:center;padding:20px">Vajuta <b>ARVUTA v5 MUDEL</b></p></div>
</div>
</div></div>

<script>
// === REAL PV DATA from Kaerap√µllu 675kWp / 500kW inverter ===
var mKWh=[3166,18873,53032,76029,88068,80792,88748,82202,65780,35925,9085,3102];
var mPeak=[211.9,468.1,488.6,489.2,488.8,489.2,489.2,488.4,488.8,488.4,308.4,175.6];
var mPlat=[0,0,16.0,36.0,35.2,19.2,26.5,16.2,13.2,2.2,0,0];
var mClip=[0,0,2694,6085,5951,3253,4474,2734,2234,378,0,0];
var hProf=[
[0,0,0,0,0,0,0,0,0.2,4.2,13,21,23.9,21.7,13.8,4.1,0.1,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,2,20.8,51,82.7,107.1,119.1,116,98,59.3,17,0.9,0,0,0,0,0,0],
[0,0,0,0,0,0,4.6,40.6,96,161.5,195.8,224.5,232.3,230.9,226.4,165.7,96.8,30.9,4.1,0.5,0,0,0,0],
[0,0,0,0,0,0.4,7.6,35.1,97.6,181.6,248.3,291.8,312.2,316.3,307.4,280.7,220.8,147.8,67.8,16.9,1.9,0,0,0],
[0,0,0,0,0.4,7,25.3,66.9,154.8,233.9,292,295.9,300.6,294,291.3,291.3,243,181.2,107.6,39.9,13.7,2,0,0],
[0,0,0,0,1.9,11.9,29.5,69.9,132.4,200,260.9,282.5,273.2,271.7,285.4,257.6,240.5,181.3,111,54.3,21.8,7,0.4,0],
[0,0,0,0,0.7,8.6,24.9,59.1,129,192.1,252.7,286,322.9,309.1,319.5,307.2,270.6,188.9,112.8,48.8,23.1,6.5,0.2,0],
[0,0,0,0,0,1.6,13.6,44.9,110.6,196.8,264.7,305.4,321.4,307.6,314.3,261.2,221.3,157.7,92.7,30.9,6.7,0.3,0,0],
[0,0,0,0,0,0,0.9,15.7,78.2,159.1,233.6,270.3,288.6,291.4,294.7,244.8,177.7,104,30.1,3.4,0,0,0,0],
[0,0,0,0,0,0,0,1.2,20.3,69.9,114.4,173.8,194.7,196.3,154.6,136.3,78.2,17.9,1.3,0,0,0,0,0],
[0,0,0,0,0,0,0,0.1,3.6,19.5,46.2,67.4,71.7,59.4,29.2,5.5,0.1,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0,0.2,3.5,14,25.5,30,17.9,8.5,0.6,0,0,0,0,0,0,0,0]
];
var mNm=['Jaan','Veebr','M√§rts','Apr','Mai','Juuni','Juuli','Aug','Sept','Okt','Nov','Dets'];
var totalPEJ=604802; // kWh

function gv(id){return parseFloat(document.getElementById(id).value)||0}
function gc(id){return document.getElementById(id).checked}
function fm(n){return Math.round(n).toLocaleString('et-EE')}
function fp(n){return n.toFixed(1)+'%'}

function lCfg(){
var c=document.getElementById('cfg').value;
var d={'500':{p:500,c:1028,u:4,x:573940},'750':{p:750,c:1542,u:6,x:692160},'1000':{p:1000,c:2056,u:8,x:810380}};
var o=d[c];document.getElementById('bP').value=o.p;document.getElementById('bC').value=o.c;document.getElementById('cx').value=o.x;
}

// Draw PV chart with SVG
function drawPV(){
var el=document.getElementById('pvChart');
var w=el.offsetWidth||700,h=200;
var mx=Math.max.apply(null,mKWh);
var bw=(w-60)/12-4;
var svg='<svg width="'+w+'" height="'+(h+50)+'" style="font-family:Arial,sans-serif;font-size:10px">';
svg+='<text x="'+(w/2)+'" y="14" text-anchor="middle" font-size="12" font-weight="bold" fill="#2B5F2B">PEJ aastane toodang: '+fm(totalPEJ)+' kWh ('+fp(totalPEJ/1000)+' MWh)</text>';
// Grid lines
for(var i=0;i<=4;i++){
var y=h-i*(h-30)/4+20;
var lbl=fm(mx/4*i);
svg+='<line x1="50" y1="'+y+'" x2="'+(w-10)+'" y2="'+y+'" stroke="#eee"/>';
svg+='<text x="46" y="'+(y+3)+'" text-anchor="end" fill="#999" font-size="9">'+lbl+'</text>';
}
// Bars
for(var m=0;m<12;m++){
var x=55+m*(bw+4);
var bh=(mKWh[m]/mx)*(h-30);
var y=h-bh+20;
var clr=mPlat[m]>0?'#E8A838':'#4CAF50';
svg+='<rect x="'+x+'" y="'+y+'" width="'+bw+'" height="'+bh+'" fill="'+clr+'" rx="2"/>';
// Clipping overlay
if(mClip[m]>0){
var ch2=(mClip[m]/mx)*(h-30);
svg+='<rect x="'+x+'" y="'+(y)+'" width="'+bw+'" height="'+Math.min(ch2,bh)+'" fill="rgba(232,168,56,0.4)" rx="2"/>';
svg+='<text x="'+(x+bw/2)+'" y="'+(y-2)+'" text-anchor="middle" fill="#D4870F" font-size="8" font-weight="bold">+'+fp(mClip[m]/1000)+'</text>';
}
svg+='<text x="'+(x+bw/2)+'" y="'+(h+35)+'" text-anchor="middle" fill="#555">'+mNm[m]+'</text>';
svg+='<text x="'+(x+bw/2)+'" y="'+(h+46)+'" text-anchor="middle" fill="#999" font-size="8">'+fp(mKWh[m]/1000)+'</text>';
}
svg+='<text x="'+(w-10)+'" y="'+(h+46)+'" text-anchor="end" fill="#D4870F" font-size="9">üüß Clipping potentsiaal (MWh)</text>';
svg+='</svg>';
el.innerHTML=svg;
}

// Financial model core
function calc(v5){
var bP=gv('bP'),bC=gv('bC'),pP=gv('pP'),iP=gv('iP'),gL=gv('gL'),cx=gv('cx');
var rte=gv('rt')/100,ie=gv('ie')/100,dg=gv('dg')/100,mc=gv('mc'),bl=gv('bl'),il=gv('il');
var wc=gv('wc')/100,inf=gv('if')/100,ox=gv('ox'),vf=gv('vf')/100,mrg=gv('mg');
var N=il,pr=pP/iP; // panel ratio 1.35

var eC=v5&&gc('eC'),eD=v5&&gc('eD'),eF=v5&&gc('eF');
var dd=gv('dd')/100,fs=gv('fs')/100,as2=gv('as')/100,arbs=gv('bs')/100;
var fcd=gv('fc'),acd=gv('ac');
var cpc=cx/mc*dd; // cost per cycle
var minSpr=eD?(mrg+cpc/(bC/1000)):0;
document.getElementById('ms').value=minSpr.toFixed(1);

var scens={opt:{lb:'Optimistlik',ut:.83,pm:1.35,am:1.3},real:{lb:'Realistlik',ut:.70,pm:1.0,am:1.0},pes:{lb:'Pessimistlik',ut:.63,pm:.65,am:.7}};
var R={};

for(var sk in scens){
var sc=scens[sk];
var cf=[],cum=-cx,totR=0,totE=0,totClipR=0,totClipMWh=0,totFcr=0,totAfrr=0,totArb=0,totCyc=0;

cf.push({y:0,em:bC/1000,pm:0,br:0,pr2:0,tr:0,op:0,vp:0,gr:0,tc:0,eb:0,fc2:-cx,cc:-cx,
cr:0,cm:0,fr:0,ar:0,abr:0,cyc:0});

for(var y=1;y<=N;y++){
// Battery degradation
var ef=ie*Math.pow(1-dg,y-1);
var eMWh=bC/1000*ef;

// PEJ: real data, slight annual panel degradation 0.5%/a
var pejDeg=Math.pow(0.995,y-1);
var pejKWh=totalPEJ*pejDeg;
// PEJ revenue from original model (~50,660 base year, varies by scenario)
var pejR=50660*sc.pm*Math.pow(1+inf,y-1)*0.95; // conservative

// === BESS Revenue ===
var bessR=0,clipR=0,clipMWh2=0,fcrR=0,afrrR=0,arbR=0,yCyc=0;

if(eF){
// FCR-D: capacity payment, minimal cycling
var fcrP=42*sc.pm*Math.pow(1+inf,y-1); // ‚Ç¨/MW/day
fcrR=fcrP*bP/1000*360*fs*sc.ut/0.7;
var fCyc=fcd*360*fs;
// aFRR: activation revenue
var afrrP=85*sc.pm*sc.am*Math.pow(1+inf,y-1);
afrrR=afrrP*bP/1000*360*as2*sc.ut/0.7*rte;
var aCyc=acd*360*as2;
// Arbitrage
var arbSpr=55*sc.pm*Math.pow(1+inf,y-1);
arbR=arbSpr*eMWh*360*arbs*sc.ut/0.7*rte;
var abCyc=1.0*360*arbs;

// Degradation filter
if(eD&&arbSpr<minSpr){arbR*=0.7;abCyc*=0.7}

yCyc=fCyc+aCyc+abCyc;
bessR=fcrR+afrrR+arbR;
}else{
// v4 style: flat revenue based on original model data
// 1000kW realistic year1 BESS revenue = 228,410 from PDF
var basePerKW=228.41*(bP/1000);
bessR=basePerKW*sc.pm*sc.ut/0.7*(1+(bP-500)/5000*0.15);
bessR*=ef/ie; // degrade
yCyc=1.2*360; // ~432 cycles/year estimate
}

// === CLIPPING CAPTURE ===
if(eC){
// Real data: mClip[m] = estimated kWh clipped per month
// Scale by battery degradation and panel degradation
for(var m2=0;m2<12;m2++){
var mClipKWh=mClip[m2]*pejDeg*ef/ie;
// Can only capture what battery can absorb
// Assume 60% of time battery has room (SOC management)
var captured=mClipKWh*0.6;
clipMWh2+=captured/1000;
}
// Revenue: captured at 0‚Ç¨ cost, sold at market price
var avgP=90*sc.pm*Math.pow(1+inf,y-1);
clipR=clipMWh2*avgP*rte;
}

totClipR+=clipR;totClipMWh+=clipMWh2;
totFcr+=fcrR;totAfrr+=afrrR;totArb+=arbR;totCyc+=yCyc;

var totalBR=bessR+clipR;
var totalR2=totalBR+pejR;
totR+=totalR2;

// Costs
var opY=ox*(bP/1000)*Math.pow(1+inf,y-1);
var vpY=totalBR*vf;
var grY=17152*Math.pow(1+inf*0.3,y-1); // grid costs, slow inflation
var tcY=opY+vpY+grY;

var eb=totalR2-tcY;
totE+=eb;
cum+=eb;

cf.push({y:y,em:eMWh,pm:pejKWh/1000,br:totalBR,pr2:pejR,tr:totalR2,
op:opY,vp:vpY,gr:grY,tc:tcY,eb:eb,fc2:eb,cc:cum,
cr:clipR,cm:clipMWh2,fr:fcrR,ar:afrrR,abr:arbR,cyc:yCyc});
}

// NPV
var npv=-cx;
for(var i=1;i<cf.length;i++)npv+=cf[i].fc2/Math.pow(1+wc,i);

// IRR
var irr=0.1;
for(var it=0;it<100;it++){
var nv=-cx,dn=0;
for(var i=1;i<cf.length;i++){var dc=Math.pow(1+irr,i);nv+=cf[i].fc2/dc;dn-=i*cf[i].fc2/Math.pow(1+irr,i+1)}
if(Math.abs(dn)<.001)break;irr-=nv/dn;
if(irr<-0.99){irr=-0.99;break}if(irr>5){irr=5;break}
}

var pb=-1;
for(var i=1;i<cf.length;i++){if(cf[i].cc>=0){pb=i;break}}

R[sk]={lb:sc.lb,npv:npv,irr:irr*100,pb:pb,roi:(cum+cx)/cx*100,
coc1:cf.length>1?cf[1].fc2/cx*100:0,em:(cum+cx)/cx,
cx:cx,tR:totR,tE:totE,f1:cf.length>1?cf[1].fc2:0,aC:totE/N,cum:cum,
eM:totR>0?totE/totR*100:0,rMW:totR/(bP/1000)/N,cMWh:cx/(bC/1000),
cf:cf,tCR:totClipR,tCM:totClipMWh,tFcr:totFcr,tAfrr:totAfrr,tArb:totArb,tCyc:totCyc,
cpc:cpc,mSpr:minSpr,pejKWh:totalPEJ};
}
return R;
}

function st(v,b,h){var ok=h?v>=b:v<=b;var nr=h?v>=b*.8:v<=b*1.2;return ok?'<span class="tg2 tg2g">üü¢</span>':nr?'<span class="tg2 tg2y">üü°</span>':'<span class="tg2 tg2r">üî¥</span>'}
function mc2(v,b,h){return(h?v>=b:v<=b)?'ok':(h?v>=b*.8:v<=b*1.2)?'wa':'ba'}

function run(){
var R=calc(true);var r=R.real,o=R.opt,p=R.pes;
var h='';

// Metrics
h+='<div class="pnl"><h2>üéØ v5 Realistlik stsenaarium ‚Äî '+document.getElementById('cfg').value+' kW</h2><div class="mg">';
h+='<div class="m '+mc2(r.npv,0,1)+'"><div class="v">‚Ç¨'+fm(r.npv)+'</div><div class="l">NPV</div><div class="s">O:‚Ç¨'+fm(o.npv)+' P:‚Ç¨'+fm(p.npv)+'</div>'+st(r.npv,0,1)+'</div>';
h+='<div class="m '+mc2(r.irr,12,1)+'"><div class="v">'+fp(r.irr)+'</div><div class="l">IRR</div><div class="s">O:'+fp(o.irr)+' P:'+fp(p.irr)+'</div>'+st(r.irr,12,1)+'</div>';
h+='<div class="m '+mc2(r.pb>0?r.pb:99,5,0)+'"><div class="v">'+(r.pb>0?r.pb+'a':'N/A')+'</div><div class="l">Payback</div><div class="s">O:'+(o.pb>0?o.pb+'a':'N/A')+' P:'+(p.pb>0?p.pb+'a':'N/A')+'</div>'+st(r.pb>0?r.pb:99,5,0)+'</div>';
h+='<div class="m '+mc2(r.eM,60,1)+'"><div class="v">'+fp(r.eM)+'</div><div class="l">EBITDA margin</div><div class="s">O:'+fp(o.eM)+' P:'+fp(p.eM)+'</div>'+st(r.eM,60,1)+'</div>';
h+='<div class="m '+mc2(r.roi,100,1)+'"><div class="v">'+fp(r.roi)+'</div><div class="l">ROI 15a</div><div class="s">O:'+fp(o.roi)+' P:'+fp(p.roi)+'</div>'+st(r.roi,100,1)+'</div>';
h+='<div class="m '+mc2(r.cum,500000,1)+'"><div class="v">‚Ç¨'+fm(r.cum)+'</div><div class="l">Kum CF a15</div><div class="s">O:‚Ç¨'+fm(o.cum)+' P:‚Ç¨'+fm(p.cum)+'</div>'+st(r.cum,500000,1)+'</div>';
h+='</div></div>';

// v5 impact
if(gc('eC')||gc('eD')||gc('eF')){
h+='<div class="pnl"><h2>üÜï v5 T√§ienduste m√µju</h2><div class="mg">';
if(gc('eC'))h+='<div class="m ok"><div class="v">‚Ç¨'+fm(r.tCR)+'</div><div class="l">Clipping Capture 15a</div><div class="s">'+fp(r.tCM)+' MWh @ 0‚Ç¨ soetuskulu</div></div>';
if(gc('eD'))h+='<div class="m"><div class="v">‚Ç¨'+fp(r.cpc)+'</div><div class="l">Kulu/ts√ºkkel</div><div class="s">Min spread: ‚Ç¨'+fp(r.mSpr)+'/MWh</div></div>';
if(gc('eF')){
var tot=r.tFcr+r.tAfrr+r.tArb;
h+='<div class="m"><div class="v">'+fm(r.tCyc)+'</div><div class="l">Ts√ºkleid 15a</div><div class="s">Max:'+fm(gv('mc'))+' ('+fp(r.tCyc/gv('mc')*100)+')</div></div>';
h+='<div class="m"><div class="v" style="font-size:14px">FCR '+(tot>0?(r.tFcr/tot*100).toFixed(0):0)+'% ¬∑ aFRR '+(tot>0?(r.tAfrr/tot*100).toFixed(0):0)+'% ¬∑ Arb '+(tot>0?(r.tArb/tot*100).toFixed(0):0)+'%</div><div class="l">Tulu jaotus</div><div class="s">‚Ç¨'+fm(r.tFcr)+' + ‚Ç¨'+fm(r.tAfrr)+' + ‚Ç¨'+fm(r.tArb)+'</div></div>';
}
h+='</div></div>';
}

// Tabs
h+='<div class="pnl"><div class="tabs">';
h+='<div class="tab on" onclick="sT(\'t1\',this)">Realistlik CF</div>';
h+='<div class="tab" onclick="sT(\'t2\',this)">3 stsenaariumi</div>';
h+='<div class="tab" onclick="sT(\'t3\',this)">PEJ toodang</div>';
if(gc('eF'))h+='<div class="tab" onclick="sT(\'t4\',this)">Turujaotus</div>';
h+='</div>';

// CF table
h+='<div id="t1" class="tc on"><table><tr><th>A</th><th>Eff MWh</th><th>PEJ MWh</th><th>BESS tulu</th><th>PEJ tulu</th><th>Kogutulu</th><th>OPEX</th><th>VPP</th><th>V√µrk</th><th>EBITDA</th><th>Vaba CF</th><th>Kum CF</th></tr>';
for(var i=0;i<r.cf.length;i++){
var c=r.cf[i];var nc=c.cc<0?' class="neg"':'';
h+='<tr><td>'+c.y+'</td><td>'+c.em.toFixed(2)+'</td><td>'+c.pm.toFixed(0)+'</td><td>'+fm(c.br)+'</td><td>'+fm(c.pr2)+'</td><td>'+fm(c.tr)+'</td><td>'+fm(c.op)+'</td><td>'+fm(c.vp)+'</td><td>'+fm(c.gr)+'</td><td>'+fm(c.eb)+'</td><td>'+fm(c.fc2)+'</td><td'+nc+'>'+fm(c.cc)+'</td></tr>';
}
h+='</table></div>';

// Scenarios table
h+='<div id="t2" class="tc"><table><tr><th>N√§itaja</th><th>Optimistlik</th><th>Realistlik</th><th>Pessimistlik</th><th>BM</th></tr>';
var rw=[
['NPV (‚Ç¨)','‚Ç¨'+fm(o.npv),'‚Ç¨'+fm(r.npv),'‚Ç¨'+fm(p.npv),'>0'],
['IRR (%)',fp(o.irr),fp(r.irr),fp(p.irr),'>12%'],
['Payback',o.pb>0?o.pb+'a':'N/A',r.pb>0?r.pb+'a':'N/A',p.pb>0?p.pb+'a':'N/A','<5a'],
['ROI 15a',fp(o.roi),fp(r.roi),fp(p.roi),'>100%'],
['Cash-on-Cash a1',fp(o.coc1),fp(r.coc1),fp(p.coc1),'>15%'],
['Equity Multiple',o.em.toFixed(1)+'x',r.em.toFixed(1)+'x',p.em.toFixed(1)+'x','>2.0x'],
['CAPEX','‚Ç¨'+fm(-cx),'‚Ç¨'+fm(-cx),'‚Ç¨'+fm(-cx),'-'],
['15a Kogutulu','‚Ç¨'+fm(o.tR),'‚Ç¨'+fm(r.tR),'‚Ç¨'+fm(p.tR),'-'],
['15a EBITDA','‚Ç¨'+fm(o.tE),'‚Ç¨'+fm(r.tE),'‚Ç¨'+fm(p.tE),'-'],
['a1 Vaba CF','‚Ç¨'+fm(o.f1),'‚Ç¨'+fm(r.f1),'‚Ç¨'+fm(p.f1),'>100k'],
['Kum CF a15','‚Ç¨'+fm(o.cum),'‚Ç¨'+fm(r.cum),'‚Ç¨'+fm(p.cum),'>500k'],
['EBITDA margin',fp(o.eM),fp(r.eM),fp(p.eM),'>60%']
];
var cx=gv('cx');
for(var i=0;i<rw.length;i++)h+='<tr><td>'+rw[i].join('</td><td>')+'</td></tr>';
h+='</table></div>';

// PEJ tab
h+='<div id="t3" class="tc"><table><tr><th>Kuu</th><th>Toodang kWh</th><th>MWh</th><th>Tipp kW</th><th>Platoo h</th><th>Clipping kWh</th><th>Profiil</th></tr>';
for(var m=0;m<12;m++){
var pct=mKWh[m]/Math.max.apply(null,mKWh)*100;
h+='<tr><td>'+mNm[m]+'</td><td>'+fm(mKWh[m])+'</td><td>'+fp(mKWh[m]/1000)+'</td><td>'+fp(mPeak[m])+'</td><td>'+fp(mPlat[m])+'</td><td>'+fm(mClip[m])+'</td><td><div class="bar" style="width:'+pct+'px;background:'+(mPlat[m]>0?'#E8A838':'#4CAF50')+'"></div></td></tr>';
}
h+='<tr style="font-weight:700;background:#f0f0f0"><td>KOKKU</td><td>'+fm(totalPEJ)+'</td><td>'+fp(totalPEJ/1000)+'</td><td>'+fp(Math.max.apply(null,mPeak))+'</td><td>'+fp(mPlat.reduce(function(a,b){return a+b},0))+'</td><td>'+fm(mClip.reduce(function(a,b){return a+b},0))+'</td><td></td></tr>';
h+='</table>';
h+='<p class="inf" style="margin-top:8px">Andmed: Kaerap√µllu m√µ√µtepunkt 38ZEE-00778874-U | 2025 | 675 kWp paneelid, 500 kW inverter | Clipping = hinnanguline energia √ºle inverteri piiri (√ó1.35 paneel/inverter suhe)</p></div>';

// Market split
if(gc('eF')){
h+='<div id="t4" class="tc"><table><tr><th>A</th><th>FCR-D</th><th>aFRR</th><th>Arbitraa≈æ</th><th>Clipping</th><th>Ts√ºkleid</th></tr>';
for(var i=1;i<r.cf.length;i++){
var c=r.cf[i];
h+='<tr><td>'+c.y+'</td><td>‚Ç¨'+fm(c.fr)+'</td><td>‚Ç¨'+fm(c.ar)+'</td><td>‚Ç¨'+fm(c.abr)+'</td><td>‚Ç¨'+fm(c.cr)+'</td><td>'+c.cyc.toFixed(0)+'</td></tr>';
}
h+='</table></div>';
}
h+='</div>';

document.getElementById('out').innerHTML='<div class="pnl"><h2>üìà Reaalne PEJ toodang 2025</h2><div id="pvChart"></div></div>'+h;
drawPV();
}

function cmp(){
var v4=calc(false),v5=calc(true);
var r4=v4.real,r5=v5.real;
var h='<div class="pnl"><h2>üìä v4 vs v5 Mudeli v√µrdlus ‚Äî Realistlik</h2>';
h+='<table><tr><th>N√§itaja</th><th>v4 (baas)</th><th>v5 (t√§iendatud)</th><th>Œî</th><th>%</th></tr>';
var cx=gv('cx');
var ps=[
['NPV (‚Ç¨)',r4.npv,r5.npv,1],['IRR (%)',r4.irr,r5.irr,1],['Payback (a)',r4.pb,r5.pb,0],
['15a Kogutulu (‚Ç¨)',r4.tR,r5.tR,1],['15a EBITDA (‚Ç¨)',r4.tE,r5.tE,1],
['Kum CF a15 (‚Ç¨)',r4.cum,r5.cum,1],['EBITDA margin (%)',r4.eM,r5.eM,1],['a1 Vaba CF (‚Ç¨)',r4.f1,r5.f1,1]
];
for(var i=0;i<ps.length;i++){
var p=ps[i],d=p[2]-p[1],pct=p[1]!=0?(d/Math.abs(p[1])*100):0;
var gd=p[3]?d>0:d<0;var cl=gd?'color:#1B7A1B':d==0?'':'color:#C0392B';
var ar=d>0?'‚Üë':d<0?'‚Üì':'‚Äî';
var v4s=p[0].indexOf('%')>-1?fp(p[1]):(p[0]=='Payback (a)'?(p[1]>0?p[1]+'a':'N/A'):'‚Ç¨'+fm(p[1]));
var v5s=p[0].indexOf('%')>-1?fp(p[2]):(p[0]=='Payback (a)'?(p[2]>0?p[2]+'a':'N/A'):'‚Ç¨'+fm(p[2]));
var ds=p[0].indexOf('%')>-1?(d>=0?'+':'')+d.toFixed(1)+'pp':(d>=0?'+‚Ç¨':'-‚Ç¨')+fm(Math.abs(d));
h+='<tr><td>'+p[0]+'</td><td>'+v4s+'</td><td><b>'+v5s+'</b></td><td style="'+cl+'"><b>'+ar+' '+ds+'</b></td><td style="'+cl+'">'+(pct>=0?'+':'')+pct.toFixed(1)+'%</td></tr>';
}
h+='</table>';

h+='<div class="imp"><h3>v5 T√§ienduste m√µju</h3>';
h+='<p>üåû <b>Clipping Capture:</b> '+(gc('eC')?'‚Ç¨'+fm(r5.tCR)+' lisatulu (15a) ‚Äî '+fp(r5.tCM)+' MWh haaratud reaalsest PEJ √ºlej√§√§gist @ 0‚Ç¨ soetuskulu':'V√§ljas')+'</p>';
h+='<p>üîã <b>Degradatsiooniarvestus:</b> '+(gc('eD')?'‚Ç¨'+fp(r5.cpc)+'/ts√ºkkel | Min spread: ‚Ç¨'+fp(r5.mSpr)+'/MWh ‚Äî madala marginaaliga arbitraa≈æ filtreeritud':'V√§ljas')+'</p>';
h+='<p>üì° <b>FCR-D/aFRR:</b> '+(gc('eF')?'FCR ‚Ç¨'+fm(r5.tFcr)+' (min kulumine) + aFRR ‚Ç¨'+fm(r5.tAfrr)+' + Arb ‚Ç¨'+fm(r5.tArb)+' | Ts√ºkleid: '+fm(r5.tCyc)+'/'+fm(gv('mc')):'V√§ljas')+'</p>';
h+='<p style="margin-top:6px">üìä <b>PEJ reaalne toodang:</b> '+fm(totalPEJ)+' kWh/a | Platoo: '+fp(mPlat.reduce(function(a,b){return a+b},0))+' h/a | Clipping potentsiaal: '+fm(mClip.reduce(function(a,b){return a+b},0))+' kWh/a</p>';
h+='</div></div>';

document.getElementById('out').innerHTML='<div class="pnl"><h2>üìà Reaalne PEJ toodang 2025</h2><div id="pvChart"></div></div>'+h;
drawPV();
}

function sT(id,el){
var ts=document.querySelectorAll('.tc');for(var i=0;i<ts.length;i++)ts[i].classList.remove('on');
document.getElementById(id).classList.add('on');
var bs=el.parentElement.querySelectorAll('.tab');for(var i=0;i<bs.length;i++)bs[i].classList.remove('on');
el.classList.add('on');
}

// Initial PV chart
setTimeout(drawPV,100);
</script>
</body>
</html>
