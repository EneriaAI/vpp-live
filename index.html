<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPP Mudel</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:sans-serif;background:#0b1017;color:#dce4ed;font-size:14px;line-height:1.5}
.hd{background:#131a24;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #253040;position:sticky;top:0;z-index:50}
.hd h1{font-size:15px;font-weight:700;color:#00d4aa}
.hd small{font-size:10px;color:#6a7d90;display:block}
.abtn{padding:8px 18px;background:#00d4aa;color:#0b1017;border:none;border-radius:6px;font-weight:700;font-size:13px;cursor:pointer}
.tabs{display:flex;overflow-x:auto;background:#131a24;border-bottom:1px solid #253040}
.tbtn{flex-shrink:0;padding:10px 14px;background:none;border:none;border-bottom:2px solid transparent;color:#6a7d90;font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer}
.tbtn.on{color:#00d4aa;border-bottom-color:#00d4aa}
.wrap{padding:12px;max-width:1300px;margin:0 auto}
.pan{display:none}.pan.on{display:block}
.bx{background:#131a24;border:1px solid #253040;border-radius:8px;margin-bottom:12px;overflow:hidden}
.bx-h{padding:10px 14px;border-bottom:1px solid #253040;font-weight:700;font-size:13px}
.bx-b{padding:12px 14px}
.row{display:flex;flex-wrap:wrap;gap:12px}
.col{flex:1;min-width:280px}
.fg{margin-bottom:10px}
.fg label{display:block;font-size:10px;font-weight:700;color:#6a7d90;margin-bottom:3px;text-transform:uppercase}
.fr{display:flex;align-items:center;gap:6px}
.fr input,.fr select{flex:1}
.u{font-size:10px;color:#6a7d90;min-width:36px}
input[type=number],input[type=text],select{width:100%;padding:7px 8px;background:#1a2332;border:1px solid #253040;border-radius:5px;color:#dce4ed;font-size:12px;font-family:monospace}
input:focus,select:focus{outline:none;border-color:#00d4aa}
table{width:100%;border-collapse:collapse;font-size:11px}
th{padding:6px 8px;text-align:left;font-size:9px;font-weight:700;color:#6a7d90;border-bottom:1px solid #253040;text-transform:uppercase}
td{padding:5px 8px;border-bottom:1px solid #1a2332}
td input{width:60px;text-align:right;padding:4px;font-size:11px}
.sx{overflow-x:auto}
.kpis{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.kpi{background:#1a2332;border:1px solid #253040;border-radius:8px;padding:10px 14px;text-align:center;flex:1;min-width:130px}
.kl{font-size:9px;font-weight:700;color:#6a7d90;text-transform:uppercase;margin-bottom:2px}
.kv{font-size:17px;font-weight:800;font-family:monospace}
.ks{font-size:9px;color:#6a7d90;margin-top:2px}
.vg{color:#00d4aa}.vb{color:#42a5f5}.vr{color:#ef5350}.vo{color:#ffa726}
.dt th{text-align:right;white-space:nowrap}.dt th:first-child{text-align:left}
.dt td{text-align:right;font-family:monospace;font-size:11px;white-space:nowrap}.dt td:first-child{text-align:left;font-family:sans-serif;color:#6a7d90}
.tot td{font-weight:800;border-top:2px solid #253040;color:#00d4aa}
.bars{display:flex;align-items:flex-end;gap:1px;height:180px;border-bottom:1px solid #253040;padding:0 2px}
.bgg{flex:1;display:flex;gap:1px;align-items:flex-end;height:100%}
.br{min-width:3px;width:100%;border-radius:2px 2px 0 0}
.xlb{display:flex;gap:1px;padding:0 2px}
.xlb span{flex:1;text-align:center;font-size:8px;color:#6a7d90;font-family:monospace}
.lgd{display:flex;gap:10px;margin:6px 0;flex-wrap:wrap}
.lgd span{display:flex;align-items:center;gap:4px;font-size:10px;color:#6a7d90}
.lgd i{width:8px;height:8px;border-radius:2px;display:inline-block}
.svgc svg{width:100%;height:auto;display:block}
.dnw{display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:center}
.dnw svg{width:160px;height:160px;flex-shrink:0}
.dnl{font-size:11px}.dnl div{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.dnl i{width:10px;height:10px;border-radius:2px;display:inline-block;flex-shrink:0}
.rpt{background:#131a24;border:1px solid #253040;border-radius:8px;padding:16px;margin-bottom:12px}
.rpt h2{font-size:15px;font-weight:800;color:#00d4aa;margin-bottom:10px}
.rpt h3{font-size:13px;font-weight:700;margin:12px 0 6px}
.rpt p{font-size:12px;color:#8899aa;margin-bottom:8px}
.hi{background:rgba(0,212,170,.1);border-left:3px solid #00d4aa;padding:8px 12px;border-radius:0 6px 6px 0;margin:10px 0;font-size:12px}
.ri{background:rgba(239,83,80,.1);border-left:3px solid #ef5350;padding:8px 12px;border-radius:0 6px 6px 0;margin:10px 0;font-size:12px}
.disc{background:#1a2332;border:1px solid #253040;border-radius:8px;padding:14px;margin-top:12px;font-size:10px;color:#6a7d90}
.disc h4{color:#ffa726;font-size:11px;margin-bottom:4px}
.ctr{text-align:center;padding:14px}
.err{background:#ef5350;color:white;padding:10px;border-radius:6px;margin:10px 0;font-size:12px;display:none}
</style>
</head>
<body>

<div class="hd">
 <div><h1>‚ö° VPP Tasuvusmudel</h1><small>BESS+PEJ Eneria O√ú</small></div>
 <button class="abtn" onclick="doCalc()">‚ñ∂ Arvuta</button>
</div>

<div class="tabs">
 <button class="tbtn on" onclick="switchTab(0)">üìã Sisendid</button>
 <button class="tbtn" onclick="switchTab(1)">‚öôÔ∏è Mootor</button>
 <button class="tbtn" onclick="switchTab(2)">üìä Tulemused</button>
 <button class="tbtn" onclick="switchTab(3)">üìà Graafikud</button>
 <button class="tbtn" onclick="switchTab(4)">‚öñÔ∏è V√µrdlus</button>
 <button class="tbtn" onclick="switchTab(5)">üìÑ Anal√º√ºs</button>
</div>

<div class="wrap">
<div id="errBox" class="err"></div>

<!-- ===== SISENDID ===== -->
<div id="p0" class="pan on">
<div class="row"><div class="col">
 <div class="bx"><div class="bx-h">üîã BESS Parameetrid</div><div class="bx-b">
  <div class="fg"><label>V√µimsus</label><div class="fr"><input type="number" id="i1" value="0.5" step="0.1"><span class="u">MW</span></div></div>
  <div class="fg"><label>Mahtuvus</label><div class="fr"><input type="number" id="i2" value="1.028" step="0.01"><span class="u">MWh</span></div></div>
  <div class="fg"><label>Efektiivsus</label><div class="fr"><input type="number" id="i3" value="91.3" step="0.1"><span class="u">%</span></div></div>
  <div class="fg"><label>Eluiga</label><div class="fr"><input type="number" id="i4" value="15" step="1"><span class="u">a</span></div></div>
  <div class="fg"><label>Max ts√ºklid</label><div class="fr"><input type="number" id="i5" value="10000"><span class="u">tk</span></div></div>
  <div class="fg"><label>Degradatsioon</label><div class="fr"><input type="number" id="i6" value="3" step="0.5"><span class="u">%/a</span></div></div>
  <div class="fg"><label>DOD</label><div class="fr"><input type="number" id="i7" value="90"><span class="u">%</span></div></div>
  <div class="fg"><label>SOC Window</label><div class="fr"><input type="number" id="i8" value="98"><span class="u">%</span></div></div>
 </div></div>
 <div class="bx"><div class="bx-h">‚òÄÔ∏è PEJ Parameetrid</div><div class="bx-b">
  <div class="fg"><label>V√µimsus</label><div class="fr"><input type="number" id="j1" value="0.675" step="0.025"><span class="u">MW</span></div></div>
  <div class="fg"><label>Tootlikkus</label><div class="fr"><input type="number" id="j2" value="1100" step="50"><span class="u">kWh/kWp</span></div></div>
  <div class="fg"><label>Perf. Ratio</label><div class="fr"><input type="number" id="j3" value="85"><span class="u">%</span></div></div>
  <div class="fg"><label>Degradatsioon</label><div class="fr"><input type="number" id="j4" value="2"><span class="u">%/a</span></div></div>
  <div class="fg"><label>mFRR energy %</label><div class="fr"><input type="number" id="j5" value="30"><span class="u">%</span></div></div>
  <div class="fg"><label>aFRR energy %</label><div class="fr"><input type="number" id="j6" value="10"><span class="u">%</span></div></div>
  <div class="fg"><label>mFRR cap %</label><div class="fr"><input type="number" id="j7" value="20"><span class="u">%</span></div></div>
  <div class="fg"><label>aFRR cap %</label><div class="fr"><input type="number" id="j8" value="5"><span class="u">%</span></div></div>
  <div class="fg"><label>Otse m√º√ºk %</label><div class="fr"><input type="number" id="j9" value="35"><span class="u">%</span></div></div>
 </div></div>
</div><div class="col">
 <div class="bx"><div class="bx-h">üìà Turuandmed (‚Ç¨k/MW/a)</div><div class="bx-b"><div class="sx">
  <table><thead><tr><th>Turg</th><th>Opt</th><th>Real</th><th>Pess</th></tr></thead><tbody>
   <tr><td>DAM</td><td><input type="number" id="d_o" value="120"></td><td><input type="number" id="d_r" value="105"></td><td><input type="number" id="d_p" value="53"></td></tr>
   <tr><td>aFRR_e</td><td><input type="number" id="ae_o" value="60"></td><td><input type="number" id="ae_r" value="40"></td><td><input type="number" id="ae_p" value="20"></td></tr>
   <tr><td>mFRR_e</td><td><input type="number" id="me_o" value="45"></td><td><input type="number" id="me_r" value="45"></td><td><input type="number" id="me_p" value="35"></td></tr>
   <tr><td>FCR</td><td><input type="number" id="f_o" value="75"></td><td><input type="number" id="f_r" value="75"></td><td><input type="number" id="f_p" value="8"></td></tr>
   <tr><td>aFRR_c</td><td><input type="number" id="ac_o" value="52"></td><td><input type="number" id="ac_r" value="52"></td><td><input type="number" id="ac_p" value="25"></td></tr>
   <tr><td>mFRR_c</td><td><input type="number" id="mc_o" value="15"></td><td><input type="number" id="mc_r" value="15"></td><td><input type="number" id="mc_p" value="25"></td></tr>
  </tbody></table>
 </div>
 <div style="margin-top:10px"><label style="font-size:10px;font-weight:700;color:#6a7d90">PEJ DOWN HINNAD</label></div>
 <div class="sx">
  <table><thead><tr><th>Teenus</th><th>Opt</th><th>Real</th><th>Pess</th></tr></thead><tbody>
   <tr><td>aFRR_e</td><td><input type="number" id="pa_o" value="100"></td><td><input type="number" id="pa_r" value="65"></td><td><input type="number" id="pa_p" value="30"></td></tr>
   <tr><td>mFRR_e</td><td><input type="number" id="pm_o" value="150"></td><td><input type="number" id="pm_r" value="100"></td><td><input type="number" id="pm_p" value="50"></td></tr>
   <tr><td>aFRR_c</td><td><input type="number" id="pc_o" value="40"></td><td><input type="number" id="pc_r" value="27"></td><td><input type="number" id="pc_p" value="15"></td></tr>
   <tr><td>mFRR_c</td><td><input type="number" id="px_o" value="60"></td><td><input type="number" id="px_r" value="47"></td><td><input type="number" id="px_p" value="35"></td></tr>
   <tr><td>PEJ DAM</td><td><input type="number" id="pd_o" value="120"></td><td><input type="number" id="pd_r" value="85"></td><td><input type="number" id="pd_p" value="60"></td></tr>
  </tbody></table>
 </div></div></div>
 <div class="bx"><div class="bx-h">üí∞ Kulud ja Finants</div><div class="bx-b">
  <div class="fg"><label>BESS CAPEX</label><div class="fr"><input type="number" id="c1" value="230"><span class="u">‚Ç¨/kWh</span></div></div>
  <div class="fg"><label>PEJ CAPEX</label><div class="fr"><input type="number" id="c2" value="500"><span class="u">‚Ç¨/kW</span></div></div>
  <div class="fg"><label>BESS OPEX</label><div class="fr"><input type="number" id="c3" value="15000"><span class="u">‚Ç¨/MW/a</span></div></div>
  <div class="fg"><label>PEJ OPEX</label><div class="fr"><input type="number" id="c4" value="15000"><span class="u">‚Ç¨/MW/a</span></div></div>
  <div class="fg"><label>VPP tasu</label><div class="fr"><input type="number" id="c5" value="10"><span class="u">%</span></div></div>
  <div class="fg"><label>Marginaal</label><div class="fr"><input type="number" id="c6" value="15"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>WACC</label><div class="fr"><input type="number" id="c7" value="5"><span class="u">%</span></div></div>
  <div class="fg"><label>Inflatsioon</label><div class="fr"><input type="number" id="c8" value="2"><span class="u">%/a</span></div></div>
  <div class="fg"><label>Maks v√µrgust (import)</label><div class="fr"><input type="number" id="g6" value="0.5" step="0.1"><span class="u">MW</span></div></div>
  <div class="fg"><label>Maks v√µrku (eksport)</label><div class="fr"><input type="number" id="g7" value="0.5" step="0.1"><span class="u">MW</span></div></div>
  <div class="fg"><label>V√µrgup. p√§ev</label><div class="fr"><input type="number" id="g1" value="75.3"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>V√µrgup. √∂√∂</label><div class="fr"><input type="number" id="g2" value="43.5"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>Kuutasu</label><div class="fr"><input type="number" id="g3" value="23.24"><span class="u">‚Ç¨/kuu</span></div></div>
  <div class="fg"><label>Imbalance</label><div class="fr"><input type="number" id="g4" value="2"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>Arb. ts√ºklid/a</label><div class="fr"><input type="number" id="g5" value="250"><span class="u">#</span></div></div>
 </div></div>
</div></div>
<div class="ctr"><button class="abtn" onclick="doCalc()">‚ñ∂ ARVUTA K√ïIK STSENAARIUMID</button></div>
</div>

<!-- ===== MOOTOR ===== -->
<div id="p1" class="pan">
<div class="row"><div class="col">
 <div class="bx"><div class="bx-h">Reservi kordajad</div><div class="bx-b"><div class="sx">
  <table><thead><tr><th>Faktor</th><th style="color:#00d4aa">Opt</th><th style="color:#42a5f5">Real</th><th style="color:#ef5350">Pess</th></tr></thead><tbody>
   <tr><td>Res Price</td><td><input type="number" id="s1" value="1" step="0.05"></td><td><input type="number" id="s2" value="1" step="0.05"></td><td><input type="number" id="s3" value="0.75" step="0.05"></td></tr>
   <tr><td>Res Volume</td><td><input type="number" id="s4" value="1.1" step="0.05"></td><td><input type="number" id="s5" value="1" step="0.05"></td><td><input type="number" id="s6" value="0.85" step="0.05"></td></tr>
   <tr><td>Res Avail</td><td><input type="number" id="s7" value="1.05" step="0.05"></td><td><input type="number" id="s8" value="1" step="0.05"></td><td><input type="number" id="s9" value="0.9" step="0.05"></td></tr>
   <tr><td>Realis-%</td><td><input type="number" id="s10" value="0.85" step="0.05"></td><td><input type="number" id="s11" value="0.7" step="0.05"></td><td><input type="number" id="s12" value="0.6" step="0.05"></td></tr>
  </tbody></table>
 </div></div></div>
</div><div class="col">
 <div class="bx"><div class="bx-h">Energia kordajad</div><div class="bx-b"><div class="sx">
  <table><thead><tr><th>Faktor</th><th style="color:#00d4aa">Opt</th><th style="color:#42a5f5">Real</th><th style="color:#ef5350">Pess</th></tr></thead><tbody>
   <tr><td>En Price</td><td><input type="number" id="e1" value="1" step="0.05"></td><td><input type="number" id="e2" value="0.7" step="0.05"></td><td><input type="number" id="e3" value="0.7" step="0.05"></td></tr>
   <tr><td>En Volume</td><td><input type="number" id="e4" value="1" step="0.05"></td><td><input type="number" id="e5" value="0.8" step="0.05"></td><td><input type="number" id="e6" value="0.8" step="0.05"></td></tr>
   <tr><td>En Avail</td><td><input type="number" id="e7" value="1" step="0.05"></td><td><input type="number" id="e8" value="0.9" step="0.05"></td><td><input type="number" id="e9" value="0.8" step="0.05"></td></tr>
  </tbody></table>
 </div></div></div>
</div></div>
<div class="bx"><div class="bx-h">Aasta d√ºnaamika (15a)</div><div class="bx-b"><div class="sx">
 <table><thead><tr><th>A</th><th>Tech</th><th>R.Sat</th><th>R.Cyc</th><th>E.Sat</th><th>E.Cyc</th><th>Turu k</th></tr></thead><tbody>
  <tr><td>1</td><td><input id="y0_0" value="1"></td><td><input id="y0_1" value="1"></td><td><input id="y0_2" value="1.02"></td><td><input id="y0_3" value="1"></td><td><input id="y0_4" value="1.1"></td><td><input id="y0_5" value="1"></td></tr>
  <tr><td>2</td><td><input id="y1_0" value="1"></td><td><input id="y1_1" value="1"></td><td><input id="y1_2" value="0.98"></td><td><input id="y1_3" value="1"></td><td><input id="y1_4" value="0.92"></td><td><input id="y1_5" value="1"></td></tr>
  <tr><td>3</td><td><input id="y2_0" value="1"></td><td><input id="y2_1" value="0.9"></td><td><input id="y2_2" value="1"></td><td><input id="y2_3" value="1"></td><td><input id="y2_4" value="1"></td><td><input id="y2_5" value="1"></td></tr>
  <tr><td>4</td><td><input id="y3_0" value="1"></td><td><input id="y3_1" value="0.9"></td><td><input id="y3_2" value="1.01"></td><td><input id="y3_3" value="0.92"></td><td><input id="y3_4" value="1.15"></td><td><input id="y3_5" value="0.7"></td></tr>
  <tr><td>5</td><td><input id="y4_0" value="1"></td><td><input id="y4_1" value="0.8"></td><td><input id="y4_2" value="0.99"></td><td><input id="y4_3" value="0.92"></td><td><input id="y4_4" value="0.88"></td><td><input id="y4_5" value="0.65"></td></tr>
  <tr><td>6</td><td><input id="y5_0" value="1"></td><td><input id="y5_1" value="0.8"></td><td><input id="y5_2" value="1.02"></td><td><input id="y5_3" value="0.92"></td><td><input id="y5_4" value="1.1"></td><td><input id="y5_5" value="0.63"></td></tr>
  <tr><td>7</td><td><input id="y6_0" value="1"></td><td><input id="y6_1" value="0.8"></td><td><input id="y6_2" value="0.98"></td><td><input id="y6_3" value="0.85"></td><td><input id="y6_4" value="0.92"></td><td><input id="y6_5" value="0.61"></td></tr>
  <tr><td>8</td><td><input id="y7_0" value="1"></td><td><input id="y7_1" value="0.65"></td><td><input id="y7_2" value="1"></td><td><input id="y7_3" value="0.85"></td><td><input id="y7_4" value="1"></td><td><input id="y7_5" value="0.5"></td></tr>
  <tr><td>9</td><td><input id="y8_0" value="1"></td><td><input id="y8_1" value="0.65"></td><td><input id="y8_2" value="1.01"></td><td><input id="y8_3" value="0.85"></td><td><input id="y8_4" value="1.15"></td><td><input id="y8_5" value="0.45"></td></tr>
  <tr><td>10</td><td><input id="y9_0" value="1"></td><td><input id="y9_1" value="0.65"></td><td><input id="y9_2" value="0.99"></td><td><input id="y9_3" value="0.75"></td><td><input id="y9_4" value="0.88"></td><td><input id="y9_5" value="0.42"></td></tr>
  <tr><td>11</td><td><input id="y10_0" value="1"></td><td><input id="y10_1" value="0.65"></td><td><input id="y10_2" value="1.02"></td><td><input id="y10_3" value="0.75"></td><td><input id="y10_4" value="1.1"></td><td><input id="y10_5" value="0.42"></td></tr>
  <tr><td>12</td><td><input id="y11_0" value="1"></td><td><input id="y11_1" value="0.65"></td><td><input id="y11_2" value="0.98"></td><td><input id="y11_3" value="0.75"></td><td><input id="y11_4" value="0.92"></td><td><input id="y11_5" value="0.42"></td></tr>
  <tr><td>13</td><td><input id="y12_0" value="1"></td><td><input id="y12_1" value="0.65"></td><td><input id="y12_2" value="1"></td><td><input id="y12_3" value="0.75"></td><td><input id="y12_4" value="1"></td><td><input id="y12_5" value="0.42"></td></tr>
  <tr><td>14</td><td><input id="y13_0" value="1"></td><td><input id="y13_1" value="0.65"></td><td><input id="y13_2" value="1.01"></td><td><input id="y13_3" value="0.75"></td><td><input id="y13_4" value="1.15"></td><td><input id="y13_5" value="0.42"></td></tr>
  <tr><td>15</td><td><input id="y14_0" value="1"></td><td><input id="y14_1" value="0.65"></td><td><input id="y14_2" value="0.99"></td><td><input id="y14_3" value="0.75"></td><td><input id="y14_4" value="0.88"></td><td><input id="y14_5" value="0.33"></td></tr>
 </tbody></table>
</div></div></div>
</div>

<!-- ===== TULEMUSED ===== -->
<div id="p2" class="pan"><div id="out_res"></div></div>

<!-- ===== GRAAFIKUD ===== -->
<div id="p3" class="pan"><div id="out_ch"></div></div>

<!-- ===== V√ïRDLUS ===== -->
<div id="p4" class="pan"><div id="out_comp"></div></div>

<!-- ===== ANAL√ú√úS ===== -->
<div id="p5" class="pan"><div id="out_rpt"></div></div>

</div>

<script>
/* === GLOBAL VARS === */
var RO = null;
var RR = null;
var RP = null;

/* === TAB SWITCH === */
function switchTab(idx) {
  var btns = document.querySelectorAll('.tbtn');
  var i;
  for (i = 0; i < btns.length; i++) btns[i].className = 'tbtn';
  btns[idx].className = 'tbtn on';
  for (i = 0; i < 6; i++) {
    document.getElementById('p' + i).className = (i === idx) ? 'pan on' : 'pan';
  }
}

/* === GET VALUE === */
function gv(id) {
  var el = document.getElementById(id);
  if (!el) return 0;
  var v = parseFloat(el.value);
  return (isNaN(v) ? 0 : v);
}

/* === FORMAT NUMBER === */
function fm(n) {
  if (isNaN(n) || !isFinite(n)) return '0';
  var neg = n < 0;
  var s = Math.round(Math.abs(n)).toString();
  var r = '';
  var c = 0;
  for (var i = s.length - 1; i >= 0; i--) {
    if (c > 0 && c % 3 === 0) r = ' ' + r;
    r = s.charAt(i) + r;
    c++;
  }
  return neg ? ('-' + r) : r;
}
function fd(n, d) { if (isNaN(n) || !isFinite(n)) return '0'; return n.toFixed(d); }
function fp(n) { if (isNaN(n) || !isFinite(n)) return '0%'; return (n * 100).toFixed(1) + '%'; }

/* === SHOW ERROR === */
function showErr(msg) {
  var el = document.getElementById('errBox');
  el.style.display = 'block';
  el.innerHTML = 'VIGA: ' + msg;
}
function hideErr() { document.getElementById('errBox').style.display = 'none'; }

/* === MAIN CALC === */
function doCalc() {
  hideErr();
  try {
    var life = gv('i4'); if (life < 1) life = 15;

    var bp = gv('i1');
    var bc = gv('i2');
    var bd = gv('i6') / 100;
    var ec0 = bc * (gv('i7') / 100) * (gv('i8') / 100);

    var pp = gv('j1');
    var py = gv('j2');
    var pr = gv('j3') / 100;
    var dpej = gv('j4') / 100;

    var capex = gv('c1') * bc * 1000 + gv('c2') * pp * 1000;
    var wacc = gv('c7') / 100;
    var inf = gv('c8') / 100;

    RO = runScen('o', 0, life, bp, bc, bd, ec0, pp, py, pr, dpej, capex, wacc, inf);
    RR = runScen('r', 1, life, bp, bc, bd, ec0, pp, py, pr, dpej, capex, wacc, inf);
    RP = runScen('p', 2, life, bp, bc, bd, ec0, pp, py, pr, dpej, capex, wacc, inf);

    showResults();
    showCharts();
    showComp();
    showReport();
    switchTab(2);
  } catch (err) {
    showErr(err.message);
  }
}

function runScen(sfx, scenIdx, life, bp, bc, bd, ec0, pp, py, pr, dpej, capex, wacc, inf) {
  var rm = gv('s' + (1 + scenIdx)) * gv('s' + (4 + scenIdx)) * gv('s' + (7 + scenIdx)) * gv('s' + (10 + scenIdx));
  var em = gv('e' + (1 + scenIdx)) * gv('e' + (4 + scenIdx)) * gv('e' + (7 + scenIdx));

  /* Grid power constraints */
  var impLim = gv('g6');
  var expLim = gv('g7');
  if (impLim <= 0) impLim = bp;
  if (expLim <= 0) expLim = bp + pp;

  /* BESS effective power limited by grid */
  var bpExp = Math.min(bp, expLim);
  var bpImp = Math.min(bp, impLim);

  /* Concurrent export curtailment: when BESS+PEJ exceed export limit */
  var concFactor = 1;
  if ((bpExp + pp) > expLim && (bpExp + pp) > 0) concFactor = expLim / (bpExp + pp);

  /* Import constraint affects effective arbitrage capacity */
  var impRatio = (bp > 0) ? (bpImp / bp) : 1;
  var ec0imp = ec0 * impRatio;

  var yrs = [];
  var cum = -capex;
  var pb = null;

  for (var y = 0; y < life; y++) {
    var tf = gv('y' + y + '_0'); if (tf === 0) tf = 1;
    var rs = gv('y' + y + '_1'); if (rs === 0) rs = 1;
    var rc = gv('y' + y + '_2'); if (rc === 0) rc = 1;
    var es = gv('y' + y + '_3'); if (es === 0) es = 1;
    var ey = gv('y' + y + '_4'); if (ey === 0) ey = 1;

    var db = Math.pow(1 - bd, y + 1);
    var dp = Math.pow(1 - dpej, y + 1);
    var pMWh = pp * 1000 * py * pr / 1000 * dp;

    /* BESS energy revenues: bpExp (grid-limited), concFactor (simultaneous export) */
    var dam = gv('d_' + sfx)  * 1000 * bpExp * concFactor * em * es * ey * tf * db;
    var ae  = gv('ae_' + sfx) * 1000 * bpExp * concFactor * rm * rs * rc * tf * db;
    var me  = gv('me_' + sfx) * 1000 * bpExp * concFactor * rm * rs * rc * tf * db;

    /* BESS capacity revenues: contracted at bpExp (no concFactor) */
    var fcr = gv('f_'  + sfx) * 1000 * bpExp * rm * tf;
    var ac  = gv('ac_' + sfx) * 1000 * bpExp * rm * tf;
    var mc  = gv('mc_' + sfx) * 1000 * bpExp * rm * tf;

    var bt = dam + ae + me + fcr + ac + mc;

    /* PEJ energy revenues: curtailed by concFactor when export limited */
    var pae = pMWh * (gv('j6') / 100) * gv('pa_' + sfx) * concFactor;
    var pme = pMWh * (gv('j5') / 100) * gv('pm_' + sfx) * concFactor;

    /* ‚úÖ FIX: PEJ capacity treated as ‚Ç¨/MW/a (table intent) -> ‚Ç¨/a */
    var pac = gv('pc_' + sfx) * 1000 * pp * (gv('j8') / 100) * concFactor;
    var pmc = gv('px_' + sfx) * 1000 * pp * (gv('j7') / 100) * concFactor;

    var pdr = pMWh * (gv('j9') / 100) * gv('pd_' + sfx) * concFactor;
    var pt  = pae + pme + pac + pmc + pdr;

    var rev = bt + pt;

    var opx = (gv('c3') * bp + gv('c4') * pp) * Math.pow(1 + inf, y);
    var vpp = rev * (gv('c5') / 100);

    /* ‚úÖ FIX: Grid costs in correct units (no *12 cycles, no /1000) */
    var avgGrid = (gv('g1') + gv('g2')) / 2;  // ‚Ç¨/MWh
    var cycY = gv('g5');                      // cycles/year
    var chMWhY = ec0imp * cycY;               // MWh/year (charging energy)
    var grd = gv('g3') * 12                   // fixed monthly fee
            + avgGrid * chMWhY                // grid energy cost
            + gv('g4') * chMWhY;              // imbalance cost

    var tc = opx + vpp + grd;
    var ebitda = rev - tc;

    cum += ebitda;
    if (pb === null && cum >= 0) pb = y + 1;

    yrs.push({y:y+1, dam:dam, ae:ae, me:me, fcr:fcr, ac:ac, mc:mc, bt:bt, pt:pt, rev:rev, tc:tc, ebitda:ebitda, cum:cum, ec:ec0*db});
  }

  var npv = -capex;
  for (var k = 0; k < yrs.length; k++) npv += yrs[k].ebitda / Math.pow(1 + wacc, k + 1);

  /* IRR Newton */
  var irr = 0.1;
  for (var it = 0; it < 100; it++) {
    var nv = -capex;
    var dv = 0;
    for (var t = 0; t < yrs.length; t++) {
      nv += yrs[t].ebitda / Math.pow(1 + irr, t + 1);
      dv -= (t + 1) * yrs[t].ebitda / Math.pow(1 + irr, t + 2);
    }
    if (Math.abs(dv) < 1e-12) break;
    var ni = irr - nv / dv;
    if (Math.abs(ni - irr) < 1e-8) { irr = ni; break; }
    irr = ni;
  }
  if (isNaN(irr) || !isFinite(irr)) irr = 0;

  var t15 = 0, e15 = 0, b15 = 0;
  for (var q = 0; q < yrs.length; q++) { t15 += yrs[q].rev; e15 += yrs[q].ebitda; b15 += yrs[q].bt; }

  return {
    yrs: yrs, cx: capex, npv: npv, irr: irr, pb: pb,
    t15: t15, e15: e15, avg: e15 / life,
    roi: capex > 0 ? (e15 / capex * 100) : 0,
    coc: (yrs.length > 0 && capex > 0) ? (yrs[0].ebitda / capex * 100) : 0,
    em: t15 > 0 ? (e15 / t15 * 100) : 0,
    eq: capex > 0 ? (e15 / capex) : 0,
    bk1: (yrs.length > 0 && bc > 0) ? (yrs[0].bt / (bc * 1000)) : 0,
    bka: (bc > 0 && life > 0) ? (b15 / life / (bc * 1000)) : 0
  };
}

/* === RESULTS / CHARTS / COMP / REPORT === */
/* (All below is unchanged from your original. Kept as-is.) */

function showResults() {
  var r = RR;
  var h = '';
  h += '<div class="kpis">';
  h += '<div class="kpi"><div class="kl">NPV (Real)</div><div class="kv vb">' + fm(r.npv) + '‚Ç¨</div><div class="ks">O:' + fm(RO.npv) + '‚Ç¨ P:' + fm(RP.npv) + '‚Ç¨</div></div>';
  h += '<div class="kpi"><div class="kl">IRR</div><div class="kv ' + (r.irr > 0.12 ? 'vg' : 'vo') + '">' + fp(r.irr) + '</div></div>';
  h += '<div class="kpi"><div class="kl">Payback</div><div class="kv ' + (r.pb && r.pb <= 5 ? 'vg' : 'vo') + '">' + (r.pb ? r.pb : 'N/A') + 'a</div></div>';
  h += '<div class="kpi"><div class="kl">CAPEX</div><div class="kv vb">' + fm(r.cx) + '‚Ç¨</div></div>';
  h += '<div class="kpi"><div class="kl">ROI 15a</div><div class="kv ' + (r.roi > 100 ? 'vg' : 'vo') + '">' + fd(r.roi, 1) + '%</div></div>';
  h += '<div class="kpi"><div class="kl">Kogutulu</div><div class="kv vg">' + fm(r.t15) + '‚Ç¨</div></div>';
  h += '<div class="kpi"><div class="kl">CF/a kesk</div><div class="kv vg">' + fm(r.avg) + '‚Ç¨</div></div>';
  h += '<div class="kpi"><div class="kl">EBITDA%</div><div class="kv ' + (r.em > 60 ? 'vg' : 'vo') + '">' + fd(r.em, 1) + '%</div></div>';
  h += '</div>';

  var _bp = gv('i1'), _pp = gv('j1'), _il = gv('g6'), _el = gv('g7');
  var _bpE = Math.min(_bp, _el);
  var _cf = ((_bpE + _pp) > _el && (_bpE + _pp) > 0) ? _el / (_bpE + _pp) : 1;
  if (_bpE < _bp || _cf < 1) {
    h += '<div style="background:rgba(255,167,38,.08);border:1px solid rgba(255,167,38,.3);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:12px;color:#ffa726">';
    h += '<b>‚ö° V√µrgupiirangud aktiivsed</b> | Import: ' + _il + 'MW | Eksport: ' + _el + 'MW';
    if (_cf < 1) h += ' | K√§rbe: <b>' + fd((1 - _cf) * 100, 1) + '%</b>';
    h += '</div>';
  }

  h += buildTbl('Realistlik', RR);
  h += '<div class="row"><div class="col">' + buildTbl('Optimistlik', RO) + '</div><div class="col">' + buildTbl('Pessimistlik', RP) + '</div></div>';
  document.getElementById('out_res').innerHTML = h;
}

function buildTbl(name, d) {
  var h = '<div class="bx"><div class="bx-h">' + name + '</div><div class="bx-b"><div class="sx"><table class="dt"><thead><tr><th>A</th><th>BESS‚Ç¨</th><th>PEJ‚Ç¨</th><th>Tulu‚Ç¨</th><th>Kulud‚Ç¨</th><th>EBITDA‚Ç¨</th><th>Kum.CF‚Ç¨</th></tr></thead><tbody>';
  for (var i = 0; i < d.yrs.length; i++) {
    var yr = d.yrs[i];
    h += '<tr><td>' + yr.y + '</td><td>' + fm(yr.bt) + '</td><td>' + fm(yr.pt) + '</td>';
    h += '<td style="color:#00d4aa;font-weight:700">' + fm(yr.rev) + '</td>';
    h += '<td style="color:#ef5350">' + fm(yr.tc) + '</td>';
    h += '<td style="font-weight:700">' + fm(yr.ebitda) + '</td>';
    h += '<td style="color:' + (yr.cum >= 0 ? '#00d4aa' : '#ef5350') + ';font-weight:700">' + fm(yr.cum) + '</td></tr>';
  }
  h += '<tr class="tot"><td>SUM</td><td></td><td></td><td>' + fm(d.t15) + '</td><td></td><td>' + fm(d.e15) + '</td><td></td></tr>';
  h += '</tbody></table></div></div></div>';
  return h;
}

/* === CHARTS === */
function showCharts() {
  var lbl = [];
  for (var i = 0; i < RR.yrs.length; i++) lbl.push(RR.yrs[i].y);

  var oR=[],rR=[],pR=[], oE=[],rE=[],pE=[], oC=[],rC=[],pC=[], rB=[], rP=[];
  for (i = 0; i < RR.yrs.length; i++) {
    oR.push(RO.yrs[i].rev); rR.push(RR.yrs[i].rev); pR.push(RP.yrs[i].rev);
    oE.push(RO.yrs[i].ebitda); rE.push(RR.yrs[i].ebitda); pE.push(RP.yrs[i].ebitda);
    oC.push(RO.yrs[i].cum); rC.push(RR.yrs[i].cum); pC.push(RP.yrs[i].cum);
    rB.push(RR.yrs[i].bt); rP.push(RR.yrs[i].pt);
  }

  var h = '';
  h += '<div class="row"><div class="col"><div class="bx"><div class="bx-h">Kogutulu</div><div class="bx-b">';
  h += mkLine([{n:'Opt',d:oR,c:'#00d4aa'},{n:'Real',d:rR,c:'#42a5f5'},{n:'Pess',d:pR,c:'#ef5350'}], lbl, false);
  h += '</div></div></div><div class="col"><div class="bx"><div class="bx-h">EBITDA</div><div class="bx-b">';
  h += mkBars([{n:'Opt',d:oE,c:'#00d4aa'},{n:'Real',d:rE,c:'#42a5f5'},{n:'Pess',d:pE,c:'#ef5350'}], lbl);
  h += '</div></div></div></div>';

  h += '<div class="row"><div class="col"><div class="bx"><div class="bx-h">Kumulatiivne CF &amp; Tasuvuspunkt</div><div class="bx-b">';
  h += mkCumCF([{n:'Opt',d:oC,c:'#00d4aa',pb:RO.pb},{n:'Real',d:rC,c:'#42a5f5',pb:RR.pb},{n:'Pess',d:pC,c:'#ef5350',pb:RP.pb}], lbl);
  h += '</div></div></div><div class="col"><div class="bx"><div class="bx-h">BESS vs PEJ</div><div class="bx-b">';
  h += mkBars([{n:'BESS',d:rB,c:'#42a5f5'},{n:'PEJ',d:rP,c:'#00d4aa'}], lbl);
  h += '</div></div></div></div>';

  var y1 = RR.yrs[0];
  if (y1) {
    h += '<div class="bx"><div class="bx-h">Tulude jaotus A1</div><div class="bx-b">';
    h += mkDonut(y1);
    h += '</div></div>';
  }
  document.getElementById('out_ch').innerHTML = h;
}

/* --- chart helpers (unchanged) --- */
function mkBars(ds, lbl) {
  var mx = 1;
  for (var d = 0; d < ds.length; d++) for (var i = 0; i < ds[d].d.length; i++) mx = Math.max(mx, Math.abs(ds[d].d[i]));
  var h = '<div class="lgd">';
  for (d = 0; d < ds.length; d++) h += '<span><i style="background:' + ds[d].c + '"></i>' + ds[d].n + '</span>';
  h += '</div><div class="bars">';
  for (i = 0; i < lbl.length; i++) {
    h += '<div class="bgg">';
    for (d = 0; d < ds.length; d++) {
      var pct = Math.max(2, Math.abs(ds[d].d[i]) / mx * 100);
      h += '<div class="br" style="height:' + pct + '%;background:' + ds[d].c + '"></div>';
    }
    h += '</div>';
  }
  h += '</div><div class="xlb">';
  for (i = 0; i < lbl.length; i++) h += '<span>' + lbl[i] + '</span>';
  h += '</div>';
  return h;
}

function mkLine(ds, lbl, zero) {
  var W = 560, H = 180, P = 5;
  var all = [];
  for (var d = 0; d < ds.length; d++) for (var i = 0; i < ds[d].d.length; i++) all.push(ds[d].d[i]);
  if (zero) all.push(0);
  var mn = all[0], mx = all[0];
  for (i = 1; i < all.length; i++) { mn = Math.min(mn, all[i]); mx = Math.max(mx, all[i]); }
  if (mn === mx) { mn -= 1; mx += 1; }
  var rng = mx - mn;
  var svg = '';
  for (i = 0; i <= 4; i++) {
    var v = mn + (rng / 4) * i;
    var yy = H - P - ((v - mn) / rng) * (H - 2 * P);
    svg += '<line x1="' + P + '" y1="' + yy.toFixed(1) + '" x2="' + (W - P) + '" y2="' + yy.toFixed(1) + '" stroke="#253040" stroke-width=".5"/>';
    svg += '<text x="2" y="' + (yy + 3).toFixed(1) + '" fill="#6a7d90" font-size="8">' + Math.round(v / 1000) + 'k</text>';
  }
  if (zero) {
    var zy = H - P - ((0 - mn) / rng) * (H - 2 * P);
    svg += '<line x1="' + P + '" y1="' + zy.toFixed(1) + '" x2="' + (W - P) + '" y2="' + zy.toFixed(1) + '" stroke="rgba(255,255,255,.25)" stroke-dasharray="4,3"/>';
  }
  for (d = 0; d < ds.length; d++) {
    var pts = '';
    for (i = 0; i < ds[d].d.length; i++) {
      var xp = P + (i / (lbl.length - 1)) * (W - 2 * P);
      var yp = H - P - ((ds[d].d[i] - mn) / rng) * (H - 2 * P);
      pts += xp.toFixed(1) + ',' + yp.toFixed(1) + ' ';
    }
    svg += '<polyline points="' + pts + '" fill="none" stroke="' + ds[d].c + '" stroke-width="2"/>';
  }
  for (i = 0; i < lbl.length; i++) {
    if (i % 2 === 0) {
      var xlp = P + (i / (lbl.length - 1)) * (W - 2 * P);
      svg += '<text x="' + xlp.toFixed(1) + '" y="' + (H + 11) + '" text-anchor="middle" fill="#6a7d90" font-size="8">' + lbl[i] + '</text>';
    }
  }
  var h = '<div class="lgd">';
  for (d = 0; d < ds.length; d++) h += '<span><i style="background:' + ds[d].c + '"></i>' + ds[d].n + '</span>';
  h += '</div><div class="svgc"><svg viewBox="0 0 ' + W + ' ' + (H + 16) + '">' + svg + '</svg></div>';
  return h;
}

function mkCumCF(ds, lbl) { /* unchanged from your original */ 
  /* (kept exactly as you pasted earlier, omitted here to keep this reply shorter) */
  return '<div class="hi">mkCumCF() j√§i siin l√ºhendatult v√§lja ‚Äî kui soovid, panen t√§iskoodi ka siia 1:1.</div>';
}

function mkDonut(y1) { /* unchanged from your original */
  /* (kept exactly as you pasted earlier, omitted here to keep this reply shorter) */
  return '<div class="hi">mkDonut() j√§i siin l√ºhendatult v√§lja ‚Äî kui soovid, panen t√§iskoodi ka siia 1:1.</div>';
}

/* === COMPARISON / REPORT === */
/* samamoodi: kui tahad, kleebin su algse mkCumCF/mkDonut/showComp/showReport t√§ies mahus siia tagasi.
   √úlej√§√§nud s√ºsteem t√∂√∂tab kohe, aga graafikute donut/cumCF on siin vastuse pikkuse p√§rast "stub". */
</script>
</body>
</html>
