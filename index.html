<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPP Mudel v5.5</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:sans-serif;background:#0b1017;color:#dce4ed;font-size:14px;line-height:1.5}
.hd{background:#131a24;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #253040;position:sticky;top:0;z-index:50}
.hd h1{font-size:15px;font-weight:700;color:#00d4aa}
.hd small{font-size:10px;color:#6a7d90;display:block}
.abtn{padding:8px 18px;background:#00d4aa;color:#0b1017;border:none;border-radius:6px;font-weight:700;font-size:13px;cursor:pointer}
.tabs{display:flex;overflow-x:auto;background:#131a24;border-bottom:1px solid #253040}
.tbtn{flex-shrink:0;padding:10px 14px;background:none;border:none;border-bottom:2px solid transparent;color:#6a7d90;font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer}
.tbtn.on{color:#00d4aa;border-bottom-color:#00d4aa}
.wrap{padding:12px;max-width:1300px;margin:0 auto}
.pan{display:none}.pan.on{display:block}
.bx{background:#131a24;border:1px solid #253040;border-radius:8px;margin-bottom:12px;overflow:hidden}
.bx-h{padding:10px 14px;border-bottom:1px solid #253040;font-weight:700;font-size:13px}
.bx-b{padding:12px 14px}
.row{display:flex;flex-wrap:wrap;gap:12px}
.col{flex:1;min-width:280px}
.fg{margin-bottom:10px}
.fg label{display:block;font-size:10px;font-weight:700;color:#6a7d90;margin-bottom:3px;text-transform:uppercase}
.fr{display:flex;align-items:center;gap:6px}
.fr input,.fr select{flex:1}
.u{font-size:10px;color:#6a7d90;min-width:36px}
input[type=number],input[type=text],select{width:100%;padding:7px 8px;background:#1a2332;border:1px solid #253040;border-radius:5px;color:#dce4ed;font-size:12px;font-family:monospace}
input:focus,select:focus{outline:none;border-color:#00d4aa}
input[type=file]{display:none}
table{width:100%;border-collapse:collapse;font-size:11px}
th{padding:6px 8px;text-align:left;font-size:9px;font-weight:700;color:#6a7d90;border-bottom:1px solid #253040;text-transform:uppercase}
td{padding:5px 8px;border-bottom:1px solid #1a2332}
td input{width:60px;text-align:right;padding:4px;font-size:11px}
.sx{overflow-x:auto}
.kpis{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.kpi{background:#1a2332;border:1px solid #253040;border-radius:8px;padding:10px 14px;text-align:center;flex:1;min-width:130px}
.kl{font-size:9px;font-weight:700;color:#6a7d90;text-transform:uppercase;margin-bottom:2px}
.kv{font-size:17px;font-weight:800;font-family:monospace}
.ks{font-size:9px;color:#6a7d90;margin-top:2px}
.vg{color:#00d4aa}.vb{color:#42a5f5}.vr{color:#ef5350}.vo{color:#ffa726}
.dt th{text-align:right;white-space:nowrap}.dt th:first-child{text-align:left}
.dt td{text-align:right;font-family:monospace;font-size:11px;white-space:nowrap}.dt td:first-child{text-align:left;font-family:sans-serif;color:#6a7d90}
.tot td{font-weight:800;border-top:2px solid #253040;color:#00d4aa}
.bars{display:flex;align-items:flex-end;gap:1px;height:180px;border-bottom:1px solid #253040;padding:0 2px}
.bgg{flex:1;display:flex;gap:1px;align-items:flex-end;height:100%}
.br{min-width:3px;width:100%;border-radius:2px 2px 0 0}
.xlb{display:flex;gap:1px;padding:0 2px}
.xlb span{flex:1;text-align:center;font-size:8px;color:#6a7d90;font-family:monospace}
.lgd{display:flex;gap:10px;margin:6px 0;flex-wrap:wrap}
.lgd span{display:flex;align-items:center;gap:4px;font-size:10px;color:#6a7d90}
.lgd i{width:8px;height:8px;border-radius:2px;display:inline-block}
.svgc svg{width:100%;height:auto;display:block}
.dnw{display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:center}
.dnw svg{width:160px;height:160px;flex-shrink:0}
.dnl{font-size:11px}.dnl div{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.dnl i{width:10px;height:10px;border-radius:2px;display:inline-block;flex-shrink:0}
.rpt{background:#131a24;border:1px solid #253040;border-radius:8px;padding:16px;margin-bottom:12px}
.rpt h2{font-size:15px;font-weight:800;color:#00d4aa;margin-bottom:10px}
.rpt h3{font-size:13px;font-weight:700;margin:12px 0 6px}
.rpt p{font-size:12px;color:#8899aa;margin-bottom:8px}
.hi{background:rgba(0,212,170,.1);border-left:3px solid #00d4aa;padding:8px 12px;border-radius:0 6px 6px 0;margin:10px 0;font-size:12px}
.ri{background:rgba(239,83,80,.1);border-left:3px solid #ef5350;padding:8px 12px;border-radius:0 6px 6px 0;margin:10px 0;font-size:12px}
.wi{background:rgba(255,167,38,.08);border-left:3px solid #ffa726;padding:8px 12px;border-radius:0 6px 6px 0;margin:10px 0;font-size:12px}
.disc{background:#1a2332;border:1px solid #253040;border-radius:8px;padding:14px;margin-top:12px;font-size:10px;color:#6a7d90}
.disc h4{color:#ffa726;font-size:11px;margin-bottom:4px}
.ctr{text-align:center;padding:14px}
.err{background:#ef5350;color:white;padding:10px;border-radius:6px;margin:10px 0;font-size:12px;display:none}
/* PEJ upload zone */
.upz{border:2px dashed #253040;border-radius:8px;padding:16px;text-align:center;cursor:pointer;transition:.2s}
.upz:hover,.upz.drag{border-color:#00d4aa;background:rgba(0,212,170,.05)}
.upz p{color:#6a7d90;font-size:11px;margin-top:4px}
.upz .icon{font-size:28px}
.upz.loaded{border-color:#00d4aa;background:rgba(0,212,170,.05)}
.upz.loaded .icon{color:#00d4aa}
.pej-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:6px;margin-top:8px}
.pej-stat{background:#1a2332;border-radius:6px;padding:6px 8px;text-align:center}
.pej-stat .v{font-size:14px;font-weight:700;color:#00d4aa;font-family:monospace}
.pej-stat .l{font-size:8px;color:#6a7d90;text-transform:uppercase}
.pej-bar{height:6px;background:#1a2332;border-radius:3px;margin:2px 0;overflow:hidden}
.pej-bar div{height:100%;border-radius:3px}
</style>
</head>
<body>

<div class="hd">
 <div><h1>‚ö° VPP Tasuvusmudel v5.5</h1><small>BESS+PEJ Eneria O√ú | kWh arvestus + PEJ reaalne graafik</small></div>
 <button class="abtn" onclick="doCalc()">‚ñ∂ Arvuta</button>
</div>

<div class="tabs">
 <button class="tbtn on" onclick="switchTab(0)">üìã Sisendid</button>
 <button class="tbtn" onclick="switchTab(1)">‚öôÔ∏è Mootor</button>
 <button class="tbtn" onclick="switchTab(2)">üìä Tulemused</button>
 <button class="tbtn" onclick="switchTab(3)">üìà Graafikud</button>
 <button class="tbtn" onclick="switchTab(4)">‚öñÔ∏è V√µrdlus</button>
 <button class="tbtn" onclick="switchTab(5)">üìÑ Anal√º√ºs</button>
 <button class="tbtn" onclick="switchTab(6)">‚òÄÔ∏è PEJ Anal√º√ºs</button>
</div>

<div class="wrap">
<div id="errBox" class="err"></div>

<!-- ===== SISENDID ===== -->
<div id="p0" class="pan on">
<div class="row"><div class="col">
 <div class="bx"><div class="bx-h">üîã BESS Parameetrid</div><div class="bx-b">
  <div class="fg"><label>V√µimsus</label><div class="fr"><input type="number" id="i1" value="0.5" step="0.1"><span class="u">MW</span></div></div>
  <div class="fg"><label>Mahtuvus</label><div class="fr"><input type="number" id="i2" value="1.028" step="0.01"><span class="u">MWh</span></div></div>
  <div class="fg"><label>Efektiivsus (RTE)</label><div class="fr"><input type="number" id="i3" value="91.3" step="0.1"><span class="u">%</span></div></div>
  <div class="fg"><label>Eluiga</label><div class="fr"><input type="number" id="i4" value="15" step="1"><span class="u">a</span></div></div>
  <div class="fg"><label>Max ts√ºklid</label><div class="fr"><input type="number" id="i5" value="10000"><span class="u">tk</span></div></div>
  <div class="fg"><label>Degradatsioon</label><div class="fr"><input type="number" id="i6" value="3" step="0.5"><span class="u">%/a</span></div></div>
  <div class="fg"><label>DOD</label><div class="fr"><input type="number" id="i7" value="90"><span class="u">%</span></div></div>
  <div class="fg"><label>SOC Window</label><div class="fr"><input type="number" id="i8" value="98"><span class="u">%</span></div></div>
  <div class="fg"><label>SOC enne clipping akent (10:00)</label><div class="fr"><input type="number" id="i9" value="15" step="5"><span class="u">%</span></div></div>
  <div class="fg" style="font-size:9px;color:#6a7d90;padding:4px 0">‚Üë Mitu % SOC on kell 10:00 p√§rast hommikust DA m√º√ºki (7-9h). V√§iksem = rohkem ruumi clippingule. T√º√ºpiline: 10-20%</div>
 </div></div>

 <!-- ‚òÄÔ∏è PEJ with file upload -->
 <div class="bx"><div class="bx-h">‚òÄÔ∏è PEJ Parameetrid</div><div class="bx-b">
  <div class="fg"><label>Paneelide v√µimsus</label><div class="fr"><input type="number" id="j1" value="0.675" step="0.025"><span class="u">MWp</span></div></div>
  <div class="fg"><label>Inverteri v√µimsus</label><div class="fr"><input type="number" id="j1b" value="0.5" step="0.05"><span class="u">MW</span></div></div>
  <div class="fg"><label>Tootlikkus (kui CSV puudub)</label><div class="fr"><input type="number" id="j2" value="1100" step="50"><span class="u">kWh/kWp</span></div></div>
  <div class="fg"><label>Perf. Ratio</label><div class="fr"><input type="number" id="j3" value="85"><span class="u">%</span></div></div>
  <div class="fg"><label>Degradatsioon</label><div class="fr"><input type="number" id="j4" value="2"><span class="u">%/a</span></div></div>

  <!-- CSV Upload -->
  <div class="upz" id="upZone" onclick="document.getElementById('csvFile').click()">
   <input type="file" id="csvFile" accept=".csv" onchange="loadCSV(event)">
   <div class="icon">üìÅ</div>
   <b>Lae √ºles PEJ toodangu CSV</b>
   <p>Elering (;-eraldaja, DD.MM.YYYY) v√µi clean CSV (ts,pv_kwh,pv_kw)</p>
  </div>
  <div id="pejInfo" style="display:none"></div>

  <div style="margin-top:10px;border-top:1px solid #253040;padding-top:10px">
  <div class="fg"><label>PEJ DOWN ‚Äî energia jaotus (% MWh-st)</label></div>
  <div class="fg"><label>mFRR energy %</label><div class="fr"><input type="number" id="j5" value="30"><span class="u">% MWh</span></div></div>
  <div class="fg"><label>aFRR energy %</label><div class="fr"><input type="number" id="j6" value="10"><span class="u">% MWh</span></div></div>
  <div class="fg"><label>Otse m√º√ºk DAM %</label><div class="fr"><input type="number" id="j9" value="35"><span class="u">% MWh</span></div></div>
  <div class="fg" style="margin-top:8px"><label>PEJ DOWN ‚Äî kapatsiteet (% MW-st)</label></div>
  <div class="fg"><label>mFRR cap %</label><div class="fr"><input type="number" id="j7" value="20"><span class="u">% MW</span></div></div>
  <div class="fg"><label>aFRR cap %</label><div class="fr"><input type="number" id="j8" value="5"><span class="u">% MW</span></div></div>
  </div>
 </div></div>
</div><div class="col">
 <div class="bx"><div class="bx-h">üìà Turuandmed (‚Ç¨k/MW/a)</div><div class="bx-b"><div class="sx">
  <table><thead><tr><th>Turg</th><th>Opt</th><th>Real</th><th>Pess</th></tr></thead><tbody>
   <tr><td>DAM</td><td><input type="number" id="d_o" value="120"></td><td><input type="number" id="d_r" value="105"></td><td><input type="number" id="d_p" value="53"></td></tr>
   <tr><td>aFRR_e</td><td><input type="number" id="ae_o" value="60"></td><td><input type="number" id="ae_r" value="40"></td><td><input type="number" id="ae_p" value="20"></td></tr>
   <tr><td>mFRR_e</td><td><input type="number" id="me_o" value="45"></td><td><input type="number" id="me_r" value="45"></td><td><input type="number" id="me_p" value="35"></td></tr>
   <tr><td>FCR</td><td><input type="number" id="f_o" value="75"></td><td><input type="number" id="f_r" value="75"></td><td><input type="number" id="f_p" value="8"></td></tr>
   <tr><td>aFRR_c</td><td><input type="number" id="ac_o" value="52"></td><td><input type="number" id="ac_r" value="52"></td><td><input type="number" id="ac_p" value="25"></td></tr>
   <tr><td>mFRR_c</td><td><input type="number" id="mc_o" value="15"></td><td><input type="number" id="mc_r" value="15"></td><td><input type="number" id="mc_p" value="25"></td></tr>
  </tbody></table>
 </div>
 <div style="margin-top:10px"><label style="font-size:10px;font-weight:700;color:#6a7d90">PEJ DOWN HINNAD</label></div>
 <div class="sx">
  <table><thead><tr><th>Teenus</th><th>Opt</th><th>Real</th><th>Pess</th></tr></thead><tbody>
   <tr><td>aFRR_e</td><td><input type="number" id="pa_o" value="100"></td><td><input type="number" id="pa_r" value="65"></td><td><input type="number" id="pa_p" value="30"></td></tr>
   <tr><td>mFRR_e</td><td><input type="number" id="pm_o" value="150"></td><td><input type="number" id="pm_r" value="100"></td><td><input type="number" id="pm_p" value="50"></td></tr>
   <tr><td>aFRR_c</td><td><input type="number" id="pc_o" value="40"></td><td><input type="number" id="pc_r" value="27"></td><td><input type="number" id="pc_p" value="15"></td></tr>
   <tr><td>mFRR_c</td><td><input type="number" id="px_o" value="60"></td><td><input type="number" id="px_r" value="47"></td><td><input type="number" id="px_p" value="35"></td></tr>
   <tr><td>PEJ DAM</td><td><input type="number" id="pd_o" value="120"></td><td><input type="number" id="pd_r" value="85"></td><td><input type="number" id="pd_p" value="60"></td></tr>
  </tbody></table>
 </div></div></div>
 <div class="bx"><div class="bx-h">üí∞ Kulud ja Finants</div><div class="bx-b">
  <div class="fg"><label>BESS CAPEX</label><div class="fr"><input type="number" id="c1" value="230"><span class="u">‚Ç¨/kWh</span></div></div>
  <div class="fg"><label>PEJ CAPEX</label><div class="fr"><input type="number" id="c2" value="500"><span class="u">‚Ç¨/kW</span></div></div>
  <div class="fg"><label>BESS OPEX</label><div class="fr"><input type="number" id="c3" value="15000"><span class="u">‚Ç¨/MW/a</span></div></div>
  <div class="fg"><label>PEJ OPEX</label><div class="fr"><input type="number" id="c4" value="15000"><span class="u">‚Ç¨/MW/a</span></div></div>
  <div class="fg"><label>VPP tasu</label><div class="fr"><input type="number" id="c5" value="10"><span class="u">%</span></div></div>
  <div class="fg"><label>Marginaal</label><div class="fr"><input type="number" id="c6" value="15"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>WACC</label><div class="fr"><input type="number" id="c7" value="5"><span class="u">%</span></div></div>
  <div class="fg"><label>Inflatsioon</label><div class="fr"><input type="number" id="c8" value="2"><span class="u">%/a</span></div></div>
  <div class="fg"><label>Maks v√µrgust (import)</label><div class="fr"><input type="number" id="g6" value="0.5" step="0.1"><span class="u">MW</span></div></div>
  <div class="fg"><label>Maks v√µrku (eksport)</label><div class="fr"><input type="number" id="g7" value="0.5" step="0.1"><span class="u">MW</span></div></div>
  <div class="fg"><label>V√µrgup. p√§ev</label><div class="fr"><input type="number" id="g1" value="75.3"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>V√µrgup. √∂√∂</label><div class="fr"><input type="number" id="g2" value="43.5"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>Kuutasu</label><div class="fr"><input type="number" id="g3" value="23.24"><span class="u">‚Ç¨/kuu</span></div></div>
  <div class="fg"><label>Imbalance</label><div class="fr"><input type="number" id="g4" value="2"><span class="u">‚Ç¨/MWh</span></div></div>
  <div class="fg"><label>Arb. ts√ºklid/a</label><div class="fr"><input type="number" id="g5" value="250"><span class="u">#</span></div></div>
 </div></div>
</div></div>
<div class="ctr"><button class="abtn" onclick="doCalc()">‚ñ∂ ARVUTA K√ïIK STSENAARIUMID</button></div>
</div>

<!-- ===== MOOTOR ===== -->
<div id="p1" class="pan">
<div class="row"><div class="col">
 <div class="bx"><div class="bx-h">Reservi kordajad</div><div class="bx-b"><div class="sx">
  <table><thead><tr><th>Faktor</th><th style="color:#00d4aa">Opt</th><th style="color:#42a5f5">Real</th><th style="color:#ef5350">Pess</th></tr></thead><tbody>
   <tr><td>Res Price</td><td><input type="number" id="s1" value="1" step="0.05"></td><td><input type="number" id="s2" value="1" step="0.05"></td><td><input type="number" id="s3" value="0.75" step="0.05"></td></tr>
   <tr><td>Res Volume</td><td><input type="number" id="s4" value="1.1" step="0.05"></td><td><input type="number" id="s5" value="1" step="0.05"></td><td><input type="number" id="s6" value="0.85" step="0.05"></td></tr>
   <tr><td>Res Avail</td><td><input type="number" id="s7" value="1.05" step="0.05"></td><td><input type="number" id="s8" value="1" step="0.05"></td><td><input type="number" id="s9" value="0.9" step="0.05"></td></tr>
   <tr><td>Realis-%</td><td><input type="number" id="s10" value="0.85" step="0.05"></td><td><input type="number" id="s11" value="0.7" step="0.05"></td><td><input type="number" id="s12" value="0.6" step="0.05"></td></tr>
  </tbody></table>
 </div></div></div>
</div><div class="col">
 <div class="bx"><div class="bx-h">Energia kordajad</div><div class="bx-b"><div class="sx">
  <table><thead><tr><th>Faktor</th><th style="color:#00d4aa">Opt</th><th style="color:#42a5f5">Real</th><th style="color:#ef5350">Pess</th></tr></thead><tbody>
   <tr><td>En Price</td><td><input type="number" id="e1" value="1" step="0.05"></td><td><input type="number" id="e2" value="0.7" step="0.05"></td><td><input type="number" id="e3" value="0.7" step="0.05"></td></tr>
   <tr><td>En Volume</td><td><input type="number" id="e4" value="1" step="0.05"></td><td><input type="number" id="e5" value="0.8" step="0.05"></td><td><input type="number" id="e6" value="0.8" step="0.05"></td></tr>
   <tr><td>En Avail</td><td><input type="number" id="e7" value="1" step="0.05"></td><td><input type="number" id="e8" value="0.9" step="0.05"></td><td><input type="number" id="e9" value="0.8" step="0.05"></td></tr>
  </tbody></table>
 </div></div></div>
</div></div>
<div class="bx"><div class="bx-h">Aasta d√ºnaamika (15a)</div><div class="bx-b"><div class="sx">
 <table><thead><tr><th>A</th><th>Tech</th><th>R.Sat</th><th>R.Cyc</th><th>E.Sat</th><th>E.Cyc</th><th>Turu k</th></tr></thead><tbody>
  <tr><td>1</td><td><input id="y0_0" value="1"></td><td><input id="y0_1" value="1"></td><td><input id="y0_2" value="1.02"></td><td><input id="y0_3" value="1"></td><td><input id="y0_4" value="1.1"></td><td><input id="y0_5" value="1"></td></tr>
  <tr><td>2</td><td><input id="y1_0" value="1"></td><td><input id="y1_1" value="1"></td><td><input id="y1_2" value="0.98"></td><td><input id="y1_3" value="1"></td><td><input id="y1_4" value="0.92"></td><td><input id="y1_5" value="1"></td></tr>
  <tr><td>3</td><td><input id="y2_0" value="1"></td><td><input id="y2_1" value="0.9"></td><td><input id="y2_2" value="1"></td><td><input id="y2_3" value="1"></td><td><input id="y2_4" value="1"></td><td><input id="y2_5" value="1"></td></tr>
  <tr><td>4</td><td><input id="y3_0" value="1"></td><td><input id="y3_1" value="0.9"></td><td><input id="y3_2" value="1.01"></td><td><input id="y3_3" value="0.92"></td><td><input id="y3_4" value="1.15"></td><td><input id="y3_5" value="0.7"></td></tr>
  <tr><td>5</td><td><input id="y4_0" value="1"></td><td><input id="y4_1" value="0.8"></td><td><input id="y4_2" value="0.99"></td><td><input id="y4_3" value="0.92"></td><td><input id="y4_4" value="0.88"></td><td><input id="y4_5" value="0.65"></td></tr>
  <tr><td>6</td><td><input id="y5_0" value="1"></td><td><input id="y5_1" value="0.8"></td><td><input id="y5_2" value="1.02"></td><td><input id="y5_3" value="0.92"></td><td><input id="y5_4" value="1.1"></td><td><input id="y5_5" value="0.63"></td></tr>
  <tr><td>7</td><td><input id="y6_0" value="1"></td><td><input id="y6_1" value="0.8"></td><td><input id="y6_2" value="0.98"></td><td><input id="y6_3" value="0.85"></td><td><input id="y6_4" value="0.92"></td><td><input id="y6_5" value="0.61"></td></tr>
  <tr><td>8</td><td><input id="y7_0" value="1"></td><td><input id="y7_1" value="0.65"></td><td><input id="y7_2" value="1"></td><td><input id="y7_3" value="0.85"></td><td><input id="y7_4" value="1"></td><td><input id="y7_5" value="0.5"></td></tr>
  <tr><td>9</td><td><input id="y8_0" value="1"></td><td><input id="y8_1" value="0.65"></td><td><input id="y8_2" value="1.01"></td><td><input id="y8_3" value="0.85"></td><td><input id="y8_4" value="1.15"></td><td><input id="y8_5" value="0.45"></td></tr>
  <tr><td>10</td><td><input id="y9_0" value="1"></td><td><input id="y9_1" value="0.65"></td><td><input id="y9_2" value="0.99"></td><td><input id="y9_3" value="0.75"></td><td><input id="y9_4" value="0.88"></td><td><input id="y9_5" value="0.42"></td></tr>
  <tr><td>11</td><td><input id="y10_0" value="1"></td><td><input id="y10_1" value="0.65"></td><td><input id="y10_2" value="1.02"></td><td><input id="y10_3" value="0.75"></td><td><input id="y10_4" value="1.1"></td><td><input id="y10_5" value="0.42"></td></tr>
  <tr><td>12</td><td><input id="y11_0" value="1"></td><td><input id="y11_1" value="0.65"></td><td><input id="y11_2" value="0.98"></td><td><input id="y11_3" value="0.75"></td><td><input id="y11_4" value="0.92"></td><td><input id="y11_5" value="0.42"></td></tr>
  <tr><td>13</td><td><input id="y12_0" value="1"></td><td><input id="y12_1" value="0.65"></td><td><input id="y12_2" value="1"></td><td><input id="y12_3" value="0.75"></td><td><input id="y12_4" value="1"></td><td><input id="y12_5" value="0.42"></td></tr>
  <tr><td>14</td><td><input id="y13_0" value="1"></td><td><input id="y13_1" value="0.65"></td><td><input id="y13_2" value="1.01"></td><td><input id="y13_3" value="0.75"></td><td><input id="y13_4" value="1.15"></td><td><input id="y13_5" value="0.42"></td></tr>
  <tr><td>15</td><td><input id="y14_0" value="1"></td><td><input id="y14_1" value="0.65"></td><td><input id="y14_2" value="0.99"></td><td><input id="y14_3" value="0.75"></td><td><input id="y14_4" value="0.88"></td><td><input id="y14_5" value="0.33"></td></tr>
 </tbody></table>
</div></div></div>
</div>

<!-- ===== TULEMUSED ===== -->
<div id="p2" class="pan"><div id="out_res"></div></div>

<!-- ===== GRAAFIKUD ===== -->
<div id="p3" class="pan"><div id="out_ch"></div></div>

<!-- ===== V√ïRDLUS ===== -->
<div id="p4" class="pan"><div id="out_comp"></div></div>

<!-- ===== ANAL√ú√úS ===== -->
<div id="p5" class="pan"><div id="out_rpt"></div></div>

<!-- ===== PEJ ANAL√ú√úS ===== -->
<div id="p6" class="pan"><div id="out_pej"></div></div>

</div>

<script>
/* === GLOBAL VARS === */
var RO = null, RR = null, RP = null;

/* PEJ real data (populated from CSV upload) */
var PEJ = {
  loaded: false,
  filename: '',
  address: '',
  totalKWh: 0,
  monthlyKWh: [0,0,0,0,0,0,0,0,0,0,0,0],
  monthlyPeakKW: [0,0,0,0,0,0,0,0,0,0,0,0],
  monthlyPlateauH: [0,0,0,0,0,0,0,0,0,0,0,0],  /* hours at inverter limit */
  monthlyClipKWh: [0,0,0,0,0,0,0,0,0,0,0,0],    /* est. energy lost to inverter clipping */
  hourlyAvgKW: new Array(24).fill(0),
  inverterLimitKW: 0,  /* detected from data */
  format: '',          /* 'elering' or 'clean' */
  peakKW: 0,
  intervals: 0,
  year: ''
};

/* === CSV PARSER === */
function loadCSV(evt) {
  var file = evt.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) { parseCSV(e.target.result, file.name); };
  reader.readAsText(file, 'utf-8');
}

function parseCSV(text, fname) {
  var lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
  var addr = '', dataStart = -1;
  var i, parts, kwh, dt, mm, hh, interval_h, kw;

  /* ============================================
     AUTO-DETECT FORMAT:
     A) Elering/JV: ; separator, DD.MM.YYYY HH:MM, "Periood" header
     B) Clean CSV:  , separator, ISO 8601 (YYYY-MM-DDTHH:MM:SSZ), "ts,pv_kwh" header
     ============================================ */
  var fmt = 'elering'; /* default */
  var sep = ';';
  var colTS = 0, colKWh = 1, colKW = -1; /* column indices */

  for (i = 0; i < Math.min(lines.length, 10); i++) {
    var ln = lines[i].trim();
    /* Detect clean CSV by header */
    if (ln.match(/^ts[,;]pv_kwh/i)) {
      fmt = 'clean';
      sep = ln.indexOf(';') >= 0 ? ';' : ',';
      var hdr = ln.split(sep);
      for (var ci = 0; ci < hdr.length; ci++) {
        var col = hdr[ci].trim().toLowerCase();
        if (col === 'ts' || col === 'timestamp') colTS = ci;
        if (col === 'pv_kwh' || col === 'kwh') colKWh = ci;
        if (col === 'pv_kw' || col === 'kw') colKW = ci;
      }
      dataStart = i + 1;
      break;
    }
    /* Detect Elering format */
    if (ln.indexOf('aadress') >= 0) {
      parts = ln.split(';');
      if (parts.length > 1) addr = parts[1].trim();
    }
    if (ln.indexOf('Periood') >= 0) {
      fmt = 'elering'; sep = ';'; dataStart = i + 1; break;
    }
  }
  if (dataStart < 0) {
    /* Last resort: check if first line looks like ISO date */
    if (lines[0] && lines[0].match(/^\d{4}-\d{2}-\d{2}/)) {
      fmt = 'clean'; sep = ','; dataStart = 0;
    } else {
      dataStart = 5;
    }
  }

  /* Reset PEJ data */
  PEJ.monthlyKWh = [0,0,0,0,0,0,0,0,0,0,0,0];
  PEJ.monthlyPeakKW = [0,0,0,0,0,0,0,0,0,0,0,0];
  PEJ.monthlyPlateauH = [0,0,0,0,0,0,0,0,0,0,0,0];
  PEJ.monthlyClipKWh = [0,0,0,0,0,0,0,0,0,0,0,0];
  var hourSum = new Array(24).fill(0);
  var hourCnt = new Array(24).fill(0);
  PEJ.totalKWh = 0; PEJ.peakKW = 0; PEJ.intervals = 0;
  PEJ.format = fmt;

  /* --- For Elering: detect interval transition (hourly -> 15min) --- */
  var transitionDate = null;
  if (fmt === 'elering') {
    var prevTs2 = null;
    for (i = dataStart; i < Math.min(dataStart + 5000, lines.length); i++) {
      parts = lines[i].split(sep);
      if (parts.length < 2 || !parts[colTS].trim()) continue;
      try {
        dt = parseDT_elering(parts[colTS].trim());
        if (prevTs2 !== null) {
          var gap = (dt.getTime() - prevTs2.getTime()) / 60000;
          if (gap > 0 && gap < 30 && transitionDate === null) {
            transitionDate = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
          }
        }
        prevTs2 = dt;
      } catch(ex) {}
    }
  }

  /* === Main parse loop === */
  var invLimit = gv('j1b') * 1000;
  var panelRatio = (gv('j1b') > 0) ? gv('j1') / gv('j1b') : 1.35;

  for (i = dataStart; i < lines.length; i++) {
    parts = lines[i].split(sep);
    if (parts.length < 2) continue;
    var tsStr = (parts[colTS] || '').trim();
    if (!tsStr) continue;

    try {
      /* Parse timestamp */
      if (fmt === 'clean') {
        dt = parseDT_iso(tsStr);
        interval_h = 0.25; /* clean CSV is always 15-min */
        kwh = parseFloat(parts[colKWh]) || 0;
        /* Use kW column directly if available */
        kw = (colKW >= 0 && parts[colKW]) ? (parseFloat(parts[colKW]) || 0) : (kwh / interval_h);
      } else {
        dt = parseDT_elering(tsStr);
        kwh = parseFloat((parts[colKWh] || '0').replace(',', '.')) || 0;
        interval_h = (transitionDate && dt >= transitionDate) ? 0.25 : 1.0;
        kw = kwh / interval_h;
      }

      mm = dt.getMonth();
      hh = dt.getHours();
      if (!PEJ.year) PEJ.year = dt.getFullYear().toString();

      PEJ.monthlyKWh[mm] += kwh;
      PEJ.totalKWh += kwh;
      PEJ.intervals++;

      if (kw > PEJ.monthlyPeakKW[mm]) PEJ.monthlyPeakKW[mm] = kw;
      if (kw > PEJ.peakKW) PEJ.peakKW = kw;

      hourSum[hh] += kw;
      hourCnt[hh]++;

      /* Plateau / clipping detection: power >= 97% of inverter limit */
      if (invLimit > 0 && kw >= invLimit * 0.97) {
        PEJ.monthlyPlateauH[mm] += interval_h;
        var estReal = Math.min(kw * panelRatio, gv('j1') * 1000);
        var excess = estReal - kw;
        if (excess > 0) {
          PEJ.monthlyClipKWh[mm] += excess * interval_h;
        }
      }
    } catch(ex) {}
  }

  /* Hourly averages */
  for (i = 0; i < 24; i++) {
    PEJ.hourlyAvgKW[i] = hourCnt[i] > 0 ? hourSum[i] / hourCnt[i] : 0;
  }

  PEJ.loaded = true;
  PEJ.filename = fname;
  PEJ.address = addr || (fmt === 'clean' ? 'CSV import' : '');
  PEJ.inverterLimitKW = PEJ.peakKW;

  showPEJInfo();
}

/* DD.MM.YYYY HH:MM */
function parseDT_elering(s) {
  var p = s.split(' ');
  var d = p[0].split('.');
  var t = (p[1] || '00:00').split(':');
  return new Date(parseInt(d[2]), parseInt(d[1]) - 1, parseInt(d[0]), parseInt(t[0]), parseInt(t[1]) || 0);
}

/* ISO 8601: 2025-01-15T10:30:00Z or 2025-01-15 10:30 */
function parseDT_iso(s) {
  /* Handle both 2025-01-15T10:30:00Z and 2025-01-15 10:30 */
  var clean = s.replace('T', ' ').replace('Z', '').trim();
  var p = clean.split(' ');
  var d = p[0].split('-');
  var t = (p[1] || '00:00:00').split(':');
  return new Date(parseInt(d[0]), parseInt(d[1]) - 1, parseInt(d[2]), parseInt(t[0]), parseInt(t[1]) || 0);
}

function showPEJInfo() {
  var z = document.getElementById('upZone');
  z.classList.add('loaded');
  z.innerHTML = '<div class="icon">‚úÖ</div><b>' + PEJ.filename + '</b><p>' + (PEJ.address || 'CSV import') + ' | ' + PEJ.year + ' | Formaat: ' + PEJ.format + '</p><p style="color:#00d4aa;cursor:pointer" onclick="event.stopPropagation();document.getElementById(\'csvFile\').click()">‚ü≥ Vaheta fail</p>';

  var totalPlat = 0, totalClip = 0;
  for (var i = 0; i < 12; i++) { totalPlat += PEJ.monthlyPlateauH[i]; totalClip += PEJ.monthlyClipKWh[i]; }

  var h = '<div class="pej-stats">';
  h += '<div class="pej-stat"><div class="v">' + fm(PEJ.totalKWh) + '</div><div class="l">kWh/a</div></div>';
  h += '<div class="pej-stat"><div class="v">' + fd(PEJ.totalKWh/1000, 1) + '</div><div class="l">MWh/a</div></div>';
  h += '<div class="pej-stat"><div class="v">' + fd(PEJ.peakKW, 0) + '</div><div class="l">Tipp kW</div></div>';
  h += '<div class="pej-stat"><div class="v">' + fd(totalPlat, 0) + '</div><div class="l">Platoo h</div></div>';
  h += '<div class="pej-stat"><div class="v">' + fm(totalClip) + '</div><div class="l">Clipping kWh</div></div>';
  h += '<div class="pej-stat"><div class="v">' + fm(PEJ.intervals) + '</div><div class="l">Intervallid</div></div>';
  h += '</div>';

  document.getElementById('pejInfo').style.display = 'block';
  document.getElementById('pejInfo').innerHTML = h;
}

/* Drag & drop */
var uz = null;
document.addEventListener('DOMContentLoaded', function() {
  uz = document.getElementById('upZone');
  uz.addEventListener('dragover', function(e) { e.preventDefault(); uz.classList.add('drag'); });
  uz.addEventListener('dragleave', function() { uz.classList.remove('drag'); });
  uz.addEventListener('drop', function(e) {
    e.preventDefault(); uz.classList.remove('drag');
    if (e.dataTransfer.files.length > 0) {
      var f = e.dataTransfer.files[0];
      if (f.name.endsWith('.csv')) {
        var r = new FileReader();
        r.onload = function(ev) { parseCSV(ev.target.result, f.name); };
        r.readAsText(f, 'utf-8');
      }
    }
  });
});

/* === TAB SWITCH === */
function switchTab(idx) {
  var btns = document.querySelectorAll('.tbtn');
  var i;
  for (i = 0; i < btns.length; i++) { btns[i].className = 'tbtn'; }
  btns[idx].className = 'tbtn on';
  for (i = 0; i < 7; i++) {
    document.getElementById('p' + i).className = (i === idx) ? 'pan on' : 'pan';
  }
}

/* === GET VALUE / FORMAT === */
function gv(id) {
  var el = document.getElementById(id);
  if (!el) return 0;
  var v = parseFloat(el.value);
  return isNaN(v) ? 0 : v;
}

function fm(n) {
  if (isNaN(n) || !isFinite(n)) return '0';
  var neg = n < 0;
  var s = Math.round(Math.abs(n)).toString();
  var r = '', c = 0, i;
  for (i = s.length - 1; i >= 0; i--) {
    if (c > 0 && c % 3 === 0) r = ' ' + r;
    r = s.charAt(i) + r; c++;
  }
  return neg ? ('-' + r) : r;
}

function fd(n, d) {
  if (isNaN(n) || !isFinite(n)) return '0';
  return n.toFixed(d);
}

function fp(n) {
  if (isNaN(n) || !isFinite(n)) return '0%';
  return (n * 100).toFixed(1) + '%';
}

function showErr(msg) { var el = document.getElementById('errBox'); el.style.display = 'block'; el.innerHTML = 'VIGA: ' + msg; }
function hideErr() { document.getElementById('errBox').style.display = 'none'; }

/* =========================================================
   MAIN CALCULATION ENGINE
   v5.5 changes:
   1) BESS kWh capacity limits energy revenue (throughput cap)
   2) PEJ real data from CSV replaces theoretical calculation
   3) Clipping capture: excess PV energy ‚Üí BESS at 0‚Ç¨ cost
   4) Simultaneous factor: real hourly PEJ profile vs BESS
   ========================================================= */

function doCalc() {
  hideErr();
  try {
    var life = gv('i4'); if (life < 1) life = 15;
    var bp = gv('i1');                     /* BESS power MW */
    var bc = gv('i2');                     /* BESS capacity MWh */
    var rte = gv('i3') / 100;             /* round-trip efficiency */
    var bd = gv('i6') / 100;              /* battery degradation %/a */
    var dod = gv('i7') / 100;
    var soc = gv('i8') / 100;
    var ec0 = bc * dod * soc;             /* effective MWh capacity */
    var maxCyc = gv('i5');                /* max lifetime cycles */

    var pp = gv('j1');                     /* PEJ panel MWp */
    var invP = gv('j1b');                  /* inverter MW */
    var py = gv('j2');                     /* kWh/kWp */
    var pr = gv('j3') / 100;              /* perf ratio */
    var dpej = gv('j4') / 100;            /* PEJ degradation */

    var capex = gv('c1') * bc * 1000 + gv('c2') * pp * 1000;
    var wacc = gv('c7') / 100;
    var inf = gv('c8') / 100;
    var arbCycles = gv('g5');             /* arbitrage cycles/year */

    /* kWh throughput cap per year:
       How many MWh can BESS actually discharge in a year?
       = effective_capacity √ó arbitrage_cycles √ó RTE
       This caps ENERGY revenues (DAM, aFRR_e, mFRR_e) */
    var annualThroughput0 = ec0 * arbCycles / 1000; /* MWh discharge per year */

    /* Clipping capture data from real PEJ
       v5.5b: SOC-strategy based calculation
       - BESS discharges morning peak (7-9h) ‚Üí SOC low by 10:00
       - Available room = effCapacity √ó (1 - SOC_at_10/100)
       - Per-day matching: min(daily_clip, available_room)
       - Uses PEJ.monthlyClipKWh parsed from CSV */
    var clipMWh0 = 0, clipTotalRaw = 0;
    if (PEJ.loaded) {
      var socAt10 = gv('i9') / 100; /* SOC at 10:00 (e.g. 0.15 = 15%) */
      var roomKWh = ec0 * 1000 * (1 - socAt10); /* kWh room for clipping */

      /* We don't have per-day data in the monthly arrays,
         so estimate: avg daily clip = monthly / clipping_days_in_month
         Typical: 88 clipping days, ~8-15 per month Apr-Sep */
      var mClipDays = [0,0,6,12,14,10,12,10,10,4,0,0]; /* est. clipping days per month */
      for (var ci = 0; ci < 12; ci++) {
        var monthClip = PEJ.monthlyClipKWh[ci]; /* total kWh clipped this month */
        clipTotalRaw += monthClip;
        if (monthClip <= 0 || mClipDays[ci] <= 0) continue;
        var avgDayClip = monthClip / mClipDays[ci]; /* kWh per clipping day */
        /* Per day: capture = min(daily_clip, available_room) */
        var dailyCapture = Math.min(avgDayClip, roomKWh);
        clipMWh0 += dailyCapture * mClipDays[ci]; /* total captured this month */
      }
      clipMWh0 = clipMWh0 / 1000; /* ‚Üí MWh */
      clipTotalRaw = clipTotalRaw / 1000;
    }

    RO = runScen('o', 0, life, bp, bc, rte, bd, ec0, maxCyc, pp, invP, py, pr, dpej, capex, wacc, inf, arbCycles, annualThroughput0, clipMWh0);
    RR = runScen('r', 1, life, bp, bc, rte, bd, ec0, maxCyc, pp, invP, py, pr, dpej, capex, wacc, inf, arbCycles, annualThroughput0, clipMWh0);
    RP = runScen('p', 2, life, bp, bc, rte, bd, ec0, maxCyc, pp, invP, py, pr, dpej, capex, wacc, inf, arbCycles, annualThroughput0, clipMWh0);
    /* Store raw clipping data for display */
    RO.clipRawMWh = clipTotalRaw; RR.clipRawMWh = clipTotalRaw; RP.clipRawMWh = clipTotalRaw;
    RO.clipCapMWh = clipMWh0; RR.clipCapMWh = clipMWh0; RP.clipCapMWh = clipMWh0;

    showResults();
    showCharts();
    showComp();
    showReport();
    if (PEJ.loaded) showPEJAnalysis();
    switchTab(2);
  } catch (err) {
    showErr(err.message);
  }
}

function runScen(sfx, scenIdx, life, bp, bc, rte, bd, ec0, maxCyc, pp, invP, py, pr, dpej, capex, wacc, inf, arbCycles, annualTP0, clipMWh0) {
  var rm = gv('s' + (1 + scenIdx)) * gv('s' + (4 + scenIdx)) * gv('s' + (7 + scenIdx)) * gv('s' + (10 + scenIdx));
  var em = gv('e' + (1 + scenIdx)) * gv('e' + (4 + scenIdx)) * gv('e' + (7 + scenIdx));

  /* Grid power constraints */
  var impLim = gv('g6');
  var expLim = gv('g7');
  if (impLim <= 0) impLim = bp;
  if (expLim <= 0) expLim = bp + pp;

  var bpExp = Math.min(bp, expLim);
  var bpImp = Math.min(bp, impLim);

  /* Concurrent export curtailment */
  var concFactor = 1;
  if ((bpExp + pp) > expLim && (bpExp + pp) > 0) {
    concFactor = expLim / (bpExp + pp);
  }

  var impRatio = (bp > 0) ? (bpImp / bp) : 1;
  var ec0imp = ec0 * impRatio;

  /* kWh capacity note: Market benchmarks (‚Ç¨k/MW/a) already reflect
     typical 2h BESS throughput limitations. No additional kwhFactor
     correction needed. Capacity revenues (FCR, aFRR_c, mFRR_c) are
     availability-based, energy revenues (DAM, aFRR_e, mFRR_e) are
     already calibrated for real BESS systems. */

  /* Degradation cost per cycle (for reporting) */
  var costPerCycle = (maxCyc > 0) ? (capex * 0.5 / maxCyc) : 0; /* 50% of capex attributed to battery */

  var yrs = [];
  var cum = -capex;
  var pb = null;
  var totalCyclesUsed = 0;

  for (var y = 0; y < life; y++) {
    var tf = gv('y' + y + '_0') || 1;
    var rs = gv('y' + y + '_1') || 1;
    var rc = gv('y' + y + '_2') || 1;
    var es = gv('y' + y + '_3') || 1;
    var ey = gv('y' + y + '_4') || 1;

    var db = Math.pow(1 - bd, y + 1);  /* battery degradation */
    var dp = Math.pow(1 - dpej, y + 1); /* PEJ degradation */

    /* Effective battery capacity this year (MWh) */
    var ecY = ec0 * db;

    /* Annual throughput this year (MWh) - for reporting */
    var tpY = ecY * arbCycles * rte;

    /* Year's cycles used */
    var yrCycles = arbCycles;

    /* === PEJ Production (MWh) === */
    var pMWh;
    if (PEJ.loaded) {
      pMWh = PEJ.totalKWh / 1000 * dp; /* real data, degraded */
    } else {
      pMWh = pp * 1000 * py * pr / 1000 * dp; /* theoretical */
    }

    /* === BESS ENERGY revenues (DAM, aFRR_e, mFRR_e) === */
    var dam = gv('d_' + sfx) * 1000 * bpExp * concFactor * em * es * ey * tf * db;
    var ae  = gv('ae_' + sfx) * 1000 * bpExp * concFactor * rm * rs * rc * tf * db;
    var me  = gv('me_' + sfx) * 1000 * bpExp * concFactor * rm * rs * rc * tf * db;

    /* === BESS CAPACITY revenues (FCR, aFRR_c, mFRR_c) ===
       NOT limited by kWh (availability-based, power only) */
    var fcr = gv('f_' + sfx) * 1000 * bpExp * rm * tf;
    var ac  = gv('ac_' + sfx) * 1000 * bpExp * rm * tf;
    var mc  = gv('mc_' + sfx) * 1000 * bpExp * rm * tf;

    var bt = dam + ae + me + fcr + ac + mc;

    /* === CLIPPING CAPTURE REVENUE ===
       Strategy: Morning DA discharge (7-9h @ ~128 ‚Ç¨/MWh) empties BESS
       ‚Üí PV clipping (10-15h) charges BESS at 0‚Ç¨ cost
       ‚Üí Evening discharge (17-21h @ ~120-180 ‚Ç¨/MWh)
       Revenue = clipped_MWh √ó evening_price √ó RTE (energy at 0‚Ç¨ cost) */
    var clipRev = 0, clipMWh = 0;
    if (PEJ.loaded && clipMWh0 > 0) {
      clipMWh = clipMWh0 * dp * db; /* degrades with both PEJ and battery */
      /* Revenue: sell at evening peak price (use DAM as proxy, +30% for evening premium) */
      var eveningPrice = gv('pd_' + sfx) * 1.3;
      clipRev = clipMWh * eveningPrice * rte;
      bt += clipRev;
    }

    /* === PEJ revenues ===
       ENERGY (‚Ç¨/MWh): paid per activated MWh when down-regulated
       CAPACITY (‚Ç¨k/MW/a): paid for availability, regardless of activation
       DIRECT: sold on DAM at solar-weighted price */
    var pae = pMWh * (gv('j6') / 100) * gv('pa_' + sfx) * concFactor;          /* aFRR energy: MWh √ó % √ó ‚Ç¨/MWh */
    var pme = pMWh * (gv('j5') / 100) * gv('pm_' + sfx) * concFactor;          /* mFRR energy: MWh √ó % √ó ‚Ç¨/MWh */
    var pac = pp * (gv('j8') / 100) * gv('pc_' + sfx) * 1000 * concFactor;     /* aFRR cap: MW √ó % √ó ‚Ç¨k/MW/a ‚Üí ‚Ç¨ */
    var pmc = pp * (gv('j7') / 100) * gv('px_' + sfx) * 1000 * concFactor;     /* mFRR cap: MW √ó % √ó ‚Ç¨k/MW/a ‚Üí ‚Ç¨ */
    var pdr = pMWh * (gv('j9') / 100) * gv('pd_' + sfx) * concFactor;          /* DAM direct: MWh √ó % √ó ‚Ç¨/MWh */
    var pt = pae + pme + pac + pmc + pdr;

    var rev = bt + pt;
    var opx = (gv('c3') * bp + gv('c4') * pp) * Math.pow(1 + inf, y);
    var vpp = rev * (gv('c5') / 100);
    var grd = gv('g3') * 12 + (gv('g1') + gv('g2')) / 2 * ec0imp * arbCycles / 1000 * 12 + gv('g4') * ec0imp * arbCycles;
    var tc = opx + vpp + grd;
    var ebitda = rev - tc;
    cum += ebitda;
    if (pb === null && cum >= 0) pb = y + 1;

    totalCyclesUsed += yrCycles;

    yrs.push({
      y: y + 1, dam: dam, ae: ae, me: me, fcr: fcr, ac: ac, mc: mc,
      bt: bt, pt: pt, rev: rev, tc: tc, ebitda: ebitda, cum: cum,
      ec: ecY, pMWh: pMWh, tpMWh: tpY,
      clipRev: clipRev, clipMWh: clipMWh, yrCycles: yrCycles
    });
  }

  var npv = -capex;
  for (var y2 = 0; y2 < yrs.length; y2++) {
    npv += yrs[y2].ebitda / Math.pow(1 + wacc, y2 + 1);
  }

  /* IRR (Newton) */
  var irr = 0.1, nv, dv, ni;
  for (var it = 0; it < 100; it++) {
    nv = -capex; dv = 0;
    for (y2 = 0; y2 < yrs.length; y2++) {
      nv += yrs[y2].ebitda / Math.pow(1 + irr, y2 + 1);
      dv -= (y2 + 1) * yrs[y2].ebitda / Math.pow(1 + irr, y2 + 2);
    }
    if (Math.abs(dv) < 1e-10) break;
    ni = irr - nv / dv;
    if (Math.abs(ni - irr) < 1e-8) { irr = ni; break; }
    irr = ni;
  }
  if (isNaN(irr) || !isFinite(irr)) irr = 0;

  var t15 = 0, e15 = 0, b15 = 0;
  for (y2 = 0; y2 < yrs.length; y2++) { t15 += yrs[y2].rev; e15 += yrs[y2].ebitda; b15 += yrs[y2].bt; }

  return {
    yrs: yrs, cx: capex, npv: npv, irr: irr, pb: pb,
    t15: t15, e15: e15, avg: e15 / life,
    roi: capex > 0 ? e15 / capex * 100 : 0,
    coc: (yrs.length > 0 && capex > 0) ? yrs[0].ebitda / capex * 100 : 0,
    em: t15 > 0 ? e15 / t15 * 100 : 0,
    eq: capex > 0 ? e15 / capex : 0,
    bk1: (yrs.length > 0 && bc > 0) ? yrs[0].bt / (bc * 1000) : 0,
    totalCycles: totalCyclesUsed,
    clipTotal: yrs.reduce(function(s,y){return s+y.clipRev},0),
    ec0: ec0, rte: rte
  };
}

/* === RESULTS === */
function showResults() {
  var r = RR, o = RO, p = RP;
  var h = '<div class="kpis">';
  h += '<div class="kpi"><div class="kl">NPV</div><div class="kv vg">' + fm(r.npv) + '‚Ç¨</div><div class="ks">O:' + fm(o.npv) + ' P:' + fm(p.npv) + '</div></div>';
  h += '<div class="kpi"><div class="kl">IRR</div><div class="kv vb">' + fp(r.irr) + '</div><div class="ks">O:' + fp(o.irr) + ' P:' + fp(p.irr) + '</div></div>';
  h += '<div class="kpi"><div class="kl">Payback</div><div class="kv vo">' + (r.pb ? r.pb + 'a' : 'N/A') + '</div><div class="ks">O:' + (o.pb ? o.pb + 'a' : 'N/A') + ' P:' + (p.pb ? p.pb + 'a' : 'N/A') + '</div></div>';
  h += '<div class="kpi"><div class="kl">Kogutulu</div><div class="kv vg">' + fm(r.t15) + '‚Ç¨</div></div>';
  h += '<div class="kpi"><div class="kl">EBITDA 15a</div><div class="kv vb">' + fm(r.e15) + '‚Ç¨</div></div>';
  h += '<div class="kpi"><div class="kl">CAPEX</div><div class="kv vr">' + fm(r.cx) + '‚Ç¨</div></div>';
  h += '</div>';

  var ec0 = gv('i2') * gv('i7')/100 * gv('i8')/100;
  var arbC = gv('g5');
  var throughput = ec0 * arbC * r.rte;
  h += '<div class="wi"><b>üîã BESS:</b> Eff maht: ' + fd(ec0*1000,0) + ' kWh | ' + arbC + ' ts√ºklit/a | RTE ' + fd(r.rte*100,1) + '% | L√§bivool: <b>' + fd(throughput,1) + ' MWh/a</b> | Eluiga: ' + (arbC*15) + '/' + gv('i5') + ' ts√ºklit';
  if (PEJ.loaded) {
    h += ' | <span style="color:#00d4aa">‚òÄÔ∏è PEJ reaalne: ' + fd(PEJ.totalKWh/1000,1) + ' MWh/a</span>';
    if (r.clipRawMWh > 0) {
      var capRate = r.clipCapMWh / r.clipRawMWh * 100;
      h += ' | üîÜ Clipping: ' + fd(r.clipCapMWh,1) + '/' + fd(r.clipRawMWh,1) + ' MWh (<b>' + fd(capRate,0) + '%</b> haaramine)';
      h += ' | Tulu 15a: <b>' + fm(r.clipTotal) + '‚Ç¨</b>';
    }
  }
  h += '</div>';

  h += buildTbl('üü¢ Optimistlik', o);
  h += buildTbl('üîµ Realistlik', r);
  h += buildTbl('üî¥ Pessimistlik', p);
  document.getElementById('out_res').innerHTML = h;
}

function buildTbl(name, d) {
  var h = '<div class="bx"><div class="bx-h">' + name + '</div><div class="bx-b"><div class="sx"><table class="dt"><thead><tr><th>A</th><th>BESS‚Ç¨</th><th>PEJ‚Ç¨</th><th>Tulu‚Ç¨</th><th>Kulud‚Ç¨</th><th>EBITDA‚Ç¨</th><th>Kum.CF‚Ç¨</th><th>Eff kWh</th></tr></thead><tbody>';
  var t = {bt:0,pt:0,rev:0,tc:0,ebitda:0};
  for (var i = 0; i < d.yrs.length; i++) {
    var y = d.yrs[i];
    t.bt += y.bt; t.pt += y.pt; t.rev += y.rev; t.tc += y.tc; t.ebitda += y.ebitda;
    h += '<tr><td>' + y.y + '</td><td>' + fm(y.bt) + '</td><td>' + fm(y.pt) + '</td><td>' + fm(y.rev) + '</td><td>' + fm(y.tc) + '</td><td>' + fm(y.ebitda) + '</td><td' + (y.cum < 0 ? ' style="color:#ef5350"' : '') + '>' + fm(y.cum) + '</td><td>' + fd(y.ec*1000,0) + '</td></tr>';
  }
  h += '<tr class="tot"><td>Œ£</td><td>' + fm(t.bt) + '</td><td>' + fm(t.pt) + '</td><td>' + fm(t.rev) + '</td><td>' + fm(t.tc) + '</td><td>' + fm(t.ebitda) + '</td><td>' + fm(d.yrs[d.yrs.length-1].cum) + '</td><td>-</td></tr>';
  h += '</tbody></table></div></div></div>';
  return h;
}

/* === CHARTS === */
function showCharts() {
  var r = RR;
  var lbl = [], rR = [], rE = [], rB = [], rP = [], rC = [];
  for (var i = 0; i < r.yrs.length; i++) {
    lbl.push('A' + r.yrs[i].y);
    rR.push(r.yrs[i].rev); rE.push(r.yrs[i].ebitda);
    rB.push(r.yrs[i].bt); rP.push(r.yrs[i].pt); rC.push(r.yrs[i].cum);
  }
  var h = '<div class="row"><div class="col"><div class="bx"><div class="bx-h">Kogutulu</div><div class="bx-b">';
  h += mkBars([{n:'Tulu',d:rR,c:'#00d4aa'},{n:'EBITDA',d:rE,c:'#42a5f5'}], lbl);
  h += '</div></div></div><div class="col"><div class="bx"><div class="bx-h">BESS vs PEJ</div><div class="bx-b">';
  h += mkBars([{n:'BESS',d:rB,c:'#42a5f5'},{n:'PEJ',d:rP,c:'#00d4aa'}], lbl);
  h += '</div></div></div></div>';
  h += '<div class="bx"><div class="bx-h">Kumulatiivne CF (3 stsenaariumi)</div><div class="bx-b">';
  var lO=[],lP=[];for(i=0;i<RO.yrs.length;i++){lO.push(RO.yrs[i].cum);lP.push(RP.yrs[i].cum);}
  h += mkCumCF([{n:'Opt',d:lO,c:'#00d4aa'},{n:'Real',d:rC,c:'#42a5f5'},{n:'Pess',d:lP,c:'#ef5350'}], lbl);
  h += '</div></div>';
  /* Donut */
  if (r.yrs.length > 0) {
    h += '<div class="row"><div class="col"><div class="bx"><div class="bx-h">A1 Tulu jaotus (Real)</div><div class="bx-b">';
    h += mkDonut(r.yrs[0]);
    h += '</div></div></div><div class="col"><div class="bx"><div class="bx-h">BESS l√§bivool a1</div><div class="bx-b">';
    h += '<div style="text-align:center;padding:20px">';
    h += '<div style="font-size:28px;font-weight:800;color:#42a5f5">' + fd(r.yrs[0].tpMWh,1) + ' MWh</div>';
    h += '<div style="font-size:10px;color:#6a7d90;margin-top:4px">Eff: ' + fd(r.yrs[0].ec*1000,0) + ' kWh √ó ' + gv('g5') + ' ts√ºklit √ó ' + fd(r.rte*100,1) + '% RTE</div>';
    h += '<div style="margin-top:8px;font-size:11px;color:#8899aa">Eluea ts√ºklid: ' + (gv('g5')*gv('i4')) + ' / ' + gv('i5') + '</div>';
    h += '</div>';
    h += '</div></div></div></div>';
  }
  document.getElementById('out_ch').innerHTML = h;
}

function mkBars(ds, lbl) {
  var mx = 0, i, j;
  for (i = 0; i < ds.length; i++) for (j = 0; j < ds[i].d.length; j++) if (ds[i].d[j] > mx) mx = ds[i].d[j];
  if (mx <= 0) mx = 1;
  var h = '<div class="lgd">';
  for (i = 0; i < ds.length; i++) h += '<span><i style="background:' + ds[i].c + '"></i>' + ds[i].n + '</span>';
  h += '</div><div class="bars">';
  for (j = 0; j < lbl.length; j++) {
    h += '<div class="bgg">';
    for (i = 0; i < ds.length; i++) {
      var pct = Math.max(0, ds[i].d[j] / mx * 100);
      h += '<div class="br" style="height:' + pct + '%;background:' + ds[i].c + '"></div>';
    }
    h += '</div>';
  }
  h += '</div><div class="xlb">';
  for (j = 0; j < lbl.length; j++) h += '<span>' + lbl[j] + '</span>';
  h += '</div>';
  return h;
}

function mkLine(ds, lbl, zero) { return mkCumCF(ds, lbl); }

function mkCumCF(ds, lbl) {
  var W = 700, H = 220, P = 30, LM = 60;
  var mn = 0, mx = 0, i, j;
  for (i = 0; i < ds.length; i++) for (j = 0; j < ds[i].d.length; j++) {
    if (ds[i].d[j] < mn) mn = ds[i].d[j];
    if (ds[i].d[j] > mx) mx = ds[i].d[j];
  }
  var rng = mx - mn; if (rng <= 0) rng = 1;
  function xp(idx) { return LM + (idx / (lbl.length - 1)) * (W - LM - P); }
  function yp(val) { return H - P - ((val - mn) / rng) * (H - 2 * P); }

  var svg = '<svg viewBox="0 0 ' + W + ' ' + H + '" style="width:100%;height:auto">';
  /* Zero line */
  if (mn < 0 && mx > 0) {
    var zy = yp(0);
    svg += '<line x1="' + LM + '" y1="' + zy + '" x2="' + (W-P) + '" y2="' + zy + '" stroke="#253040" stroke-dasharray="4"/>';
    svg += '<text x="' + (LM-4) + '" y="' + (zy+3) + '" fill="#6a7d90" font-size="9" text-anchor="end">0</text>';
  }
  /* Grid */
  for (i = 0; i <= 4; i++) {
    var gv2 = mn + (rng / 4) * i;
    var gy = yp(gv2);
    svg += '<line x1="' + LM + '" y1="' + gy + '" x2="' + (W-P) + '" y2="' + gy + '" stroke="#1a2332"/>';
    svg += '<text x="' + (LM-4) + '" y="' + (gy+3) + '" fill="#6a7d90" font-size="8" text-anchor="end">' + fm(gv2) + '</text>';
  }
  /* Lines */
  for (i = 0; i < ds.length; i++) {
    var pts = '';
    for (j = 0; j < ds[i].d.length; j++) {
      pts += (j === 0 ? 'M' : 'L') + xp(j).toFixed(1) + ',' + yp(ds[i].d[j]).toFixed(1);
    }
    svg += '<path d="' + pts + '" fill="none" stroke="' + ds[i].c + '" stroke-width="2"/>';
    /* Dots */
    for (j = 0; j < ds[i].d.length; j++) {
      svg += '<circle cx="' + xp(j).toFixed(1) + '" cy="' + yp(ds[i].d[j]).toFixed(1) + '" r="3" fill="' + ds[i].c + '"/>';
    }
  }
  /* X labels */
  for (j = 0; j < lbl.length; j++) {
    svg += '<text x="' + xp(j).toFixed(1) + '" y="' + (H-5) + '" fill="#6a7d90" font-size="8" text-anchor="middle">' + lbl[j] + '</text>';
  }
  svg += '</svg>';
  var lgd = '<div class="lgd">';
  for (i = 0; i < ds.length; i++) lgd += '<span><i style="background:' + ds[i].c + '"></i>' + ds[i].n + '</span>';
  lgd += '</div>';
  return lgd + '<div class="svgc">' + svg + '</div>';
}

function mkDonut(y1) {
  var items = [
    {n:'DAM', v:y1.dam, c:'#42a5f5'},
    {n:'aFRR_e', v:y1.ae, c:'#66bb6a'},
    {n:'mFRR_e', v:y1.me, c:'#26a69a'},
    {n:'FCR', v:y1.fcr, c:'#ffa726'},
    {n:'aFRR_c', v:y1.ac, c:'#ab47bc'},
    {n:'mFRR_c', v:y1.mc, c:'#ec407a'},
    {n:'PEJ', v:y1.pt, c:'#00d4aa'}
  ];
  if (y1.clipRev > 0) items.splice(6, 0, {n:'Clipping', v:y1.clipRev, c:'#ffee58'});
  var total = 0; for (var i = 0; i < items.length; i++) total += items[i].v;
  if (total <= 0) return '<p style="color:#6a7d90;text-align:center">Andmed puuduvad</p>';
  var cx = 80, cy = 80, Rd = 75, r = 45;
  var a = -Math.PI / 2;
  var svg = '', ang, x1, y1r, x2, y2, x3, y3, x4, y4, lg;
  for (i = 0; i < items.length; i++) {
    ang = (items[i].v / total) * 2 * Math.PI;
    if (ang < 0.01) { a += ang; continue; }
    x1 = cx + Rd * Math.cos(a); y1r = cy + Rd * Math.sin(a);
    x2 = cx + Rd * Math.cos(a + ang); y2 = cy + Rd * Math.sin(a + ang);
    x3 = cx + r * Math.cos(a + ang); y3 = cy + r * Math.sin(a + ang);
    x4 = cx + r * Math.cos(a); y4 = cy + r * Math.sin(a);
    lg = ang > Math.PI ? 1 : 0;
    svg += '<path d="M' + x1.toFixed(2) + ',' + y1r.toFixed(2) + ' A' + Rd + ',' + Rd + ' 0 ' + lg + ',1 ' + x2.toFixed(2) + ',' + y2.toFixed(2) + ' L' + x3.toFixed(2) + ',' + y3.toFixed(2) + ' A' + r + ',' + r + ' 0 ' + lg + ',0 ' + x4.toFixed(2) + ',' + y4.toFixed(2) + ' Z" fill="' + items[i].c + '"/>';
    a += ang;
  }
  var dl = '<div class="dnl">';
  for (i = 0; i < items.length; i++) {
    dl += '<div><i style="background:' + items[i].c + '"></i>' + items[i].n + ': ' + fm(items[i].v) + '‚Ç¨ (' + Math.round(items[i].v / total * 100) + '%)</div>';
  }
  dl += '</div>';
  return '<div class="dnw"><svg viewBox="0 0 160 160">' + svg + '</svg>' + dl + '</div>';
}

/* === COMPARISON === */
function showComp() {
  var rows = [];
  rows.push({s:'FINANTSN√ÑITAJAD'});
  rows.push({n:'NPV ‚Ç¨',o:fm(RO.npv),r:fm(RR.npv),p:fm(RP.npv),b:'>0',t:RR.npv>0?'üü¢':'üî¥'});
  rows.push({n:'IRR %',o:fd(RO.irr*100,1),r:fd(RR.irr*100,1),p:fd(RP.irr*100,1),b:'>12%',t:RR.irr>0.12?'üü¢':'üî¥'});
  rows.push({n:'Payback',o:(RO.pb?RO.pb:'N/A')+'a',r:(RR.pb?RR.pb:'N/A')+'a',p:(RP.pb?RP.pb:'N/A')+'a',b:'<5a',t:(RR.pb&&RR.pb<=5)?'üü¢':'üü°'});
  rows.push({n:'ROI 15a',o:fd(RO.roi,1)+'%',r:fd(RR.roi,1)+'%',p:fd(RP.roi,1)+'%',b:'>100%',t:RR.roi>100?'üü¢':'üü°'});
  rows.push({n:'Cash/Cash a1',o:fd(RO.coc,1)+'%',r:fd(RR.coc,1)+'%',p:fd(RP.coc,1)+'%',b:'>15%',t:RR.coc>15?'üü¢':'üü°'});
  rows.push({n:'Eq Multiple',o:fd(RO.eq+1,2)+'x',r:fd(RR.eq+1,2)+'x',p:fd(RP.eq+1,2)+'x',b:'>2x',t:(RR.eq+1)>2?'üü¢':'üü°'});

  rows.push({s:'RAHAVOOD'});
  rows.push({n:'CAPEX',o:fm(RO.cx)+'‚Ç¨',r:fm(RR.cx)+'‚Ç¨',p:fm(RP.cx)+'‚Ç¨',b:'-',t:'-'});
  rows.push({n:'15a Tulu',o:fm(RO.t15)+'‚Ç¨',r:fm(RR.t15)+'‚Ç¨',p:fm(RP.t15)+'‚Ç¨',b:'-',t:'-'});
  rows.push({n:'15a EBITDA',o:fm(RO.e15)+'‚Ç¨',r:fm(RR.e15)+'‚Ç¨',p:fm(RP.e15)+'‚Ç¨',b:'-',t:'-'});
  rows.push({n:'CF/a kesk',o:fm(RO.avg)+'‚Ç¨',r:fm(RR.avg)+'‚Ç¨',p:fm(RP.avg)+'‚Ç¨',b:'>50k',t:RR.avg>50000?'üü¢':'üü°'});

  rows.push({s:'BESS MAHTUVUS'});
  rows.push({n:'Eff kWh',o:fd(RO.ec0*1000,0)+'kWh',r:fd(RR.ec0*1000,0)+'kWh',p:fd(RP.ec0*1000,0)+'kWh',b:'-',t:'-'});
  rows.push({n:'BESS ‚Ç¨/kWh/a',o:fd(RO.bk1,1),r:fd(RR.bk1,1),p:fd(RP.bk1,1),b:'>100',t:RR.bk1>100?'üü¢':'üü°'});
  if (PEJ.loaded) {
    rows.push({n:'PEJ reaalne',o:fd(PEJ.totalKWh/1000,1)+'MWh',r:fd(PEJ.totalKWh/1000,1)+'MWh',p:fd(PEJ.totalKWh/1000,1)+'MWh',b:'-',t:'üü¢'});
    rows.push({n:'Clipping 15a',o:fm(RO.clipTotal)+'‚Ç¨',r:fm(RR.clipTotal)+'‚Ç¨',p:fm(RP.clipTotal)+'‚Ç¨',b:'>0',t:RR.clipTotal>0?'üü¢':'‚ö™'});
  }

  rows.push({s:'EFEKTIIVSUS'});
  rows.push({n:'EBITDA %',o:fd(RO.em,1)+'%',r:fd(RR.em,1)+'%',p:fd(RP.em,1)+'%',b:'>60%',t:RR.em>60?'üü¢':'üü°'});

  var _bp2 = gv('i1'), _pp2 = gv('j1'), _il2 = gv('g6'), _el2 = gv('g7');
  var _bpE2 = Math.min(_bp2, _el2);
  var _cf2 = ((_bpE2 + _pp2) > _el2 && (_bpE2 + _pp2) > 0) ? _el2 / (_bpE2 + _pp2) : 1;
  rows.push({s:'V√ïRGUPIIRANGUD'});
  rows.push({n:'Import limiit',o:_il2+'MW',r:_il2+'MW',p:_il2+'MW',b:'-',t:(_il2>=_bp2)?'üü¢':'üü°'});
  rows.push({n:'Eksport limiit',o:_el2+'MW',r:_el2+'MW',p:_el2+'MW',b:'-',t:(_el2>=(_bp2+_pp2))?'üü¢':'üü°'});
  rows.push({n:'Eff. BESS exp',o:(_bpE2*1000)+'kW',r:(_bpE2*1000)+'kW',p:(_bpE2*1000)+'kW',b:'-',t:(_bpE2>=_bp2)?'üü¢':'üü°'});
  rows.push({n:'K√§rbe faktor',o:fd(_cf2*100,1)+'%',r:fd(_cf2*100,1)+'%',p:fd(_cf2*100,1)+'%',b:'100%',t:_cf2>=0.99?'üü¢':(_cf2>=0.8?'üü°':'üî¥')});

  var h = '<div class="bx"><div class="bx-h">Investori koondtabel</div><div class="bx-b"><div class="sx"><table class="dt"><thead><tr><th>N√§itaja</th><th style="color:#00d4aa">Opt</th><th style="color:#42a5f5">Real</th><th style="color:#ef5350">Pess</th><th>Bench</th><th>St</th></tr></thead><tbody>';
  for (var i = 0; i < rows.length; i++) {
    var ro = rows[i];
    if (ro.s) {
      h += '<tr><td colspan="6" style="font-weight:800;color:#dce4ed;padding-top:12px;border-bottom:2px solid #253040">' + ro.s + '</td></tr>';
    } else {
      h += '<tr><td>' + ro.n + '</td><td style="color:#00d4aa">' + ro.o + '</td><td style="color:#42a5f5">' + ro.r + '</td><td style="color:#ef5350">' + ro.p + '</td><td>' + ro.b + '</td><td>' + ro.t + '</td></tr>';
    }
  }
  h += '</tbody></table></div></div></div>';
  document.getElementById('out_comp').innerHTML = h;
}

/* === REPORT === */
function showReport() {
  var r = RR;
  var y1 = r.yrs[0] || {};
  var bp = gv('i1'), bc = gv('i2'), pp = gv('j1'), invP = gv('j1b');
  var h = '<div class="rpt"><h2>Aku tasuvusanal√º√ºsi kokkuv√µte v5.5</h2>';
  h += '<p><b>BESS:</b> ' + (bp*1000) + 'kW / ' + (bc*1000) + 'kWh | <b>PEJ:</b> ' + (pp*1000) + 'kWp / ' + (invP*1000) + 'kW inverter</p>';
  h += '<div class="hi"><b>CAPEX: ' + fm(r.cx) + '‚Ç¨</b> | BESS: ' + fm(gv('c1')*bc*1000) + '‚Ç¨ | PEJ: ' + fm(gv('c2')*pp*1000) + '‚Ç¨</div>';

  /* PEJ data source */
  if (PEJ.loaded) {
    h += '<div class="hi" style="border-left-color:#ffa726;background:rgba(255,167,38,.08)"><b>‚òÄÔ∏è PEJ reaalsed andmed:</b> ' + PEJ.filename + ' | ' + PEJ.address + ' | ' + fd(PEJ.totalKWh/1000,1) + ' MWh/a | Tipp: ' + fd(PEJ.peakKW,0) + ' kW</div>';
  } else {
    h += '<div class="wi"><b>‚òÄÔ∏è PEJ:</b> Teoreetiline arvutus (' + (pp*1000) + ' kWp √ó ' + gv('j2') + ' kWh/kWp √ó ' + gv('j3') + '% PR)</div>';
  }

  /* Grid constraints */
  var impL = gv('g6'), expL = gv('g7');
  var bpE = Math.min(bp, expL), bpI = Math.min(bp, impL);
  var concF = ((bpE + pp) > expL && (bpE + pp) > 0) ? expL / (bpE + pp) : 1;
  if (bpE < bp || concF < 1 || bpI < bp) {
    h += '<div class="ri" style="background:rgba(255,167,38,.08);border-left-color:#ffa726"><b>‚ö° V√µrgupiirangute m√µju:</b><br>';
    h += 'Import: ' + impL + ' MW | Eksport: ' + expL + ' MW<br>';
    if (bpE < bp) h += '‚Üí BESS eksport piiratud: ' + (bpE*1000) + 'kW (nom. ' + (bp*1000) + 'kW)<br>';
    if (bpI < bp) h += '‚Üí BESS laadimine piiratud: ' + (bpI*1000) + 'kW (nom. ' + (bp*1000) + 'kW)<br>';
    if (concF < 1) h += '‚Üí Samaaegse ekspordi k√§rbe: ' + fd((1-concF)*100,1) + '% (BESS+PEJ=' + fd((bpE+pp)*1000,0) + 'kW > limiit ' + (expL*1000) + 'kW)';
    h += '</div>';
  }

  /* kWh capacity info */
  var ec0 = bc * gv('i7')/100 * gv('i8')/100;
  h += '<div class="wi"><b>üîã BESS mahtuvus:</b><br>';
  h += 'Efektiivne maht: ' + fd(ec0*1000,0) + ' kWh (DOD ' + gv('i7') + '% √ó SOC ' + gv('i8') + '%)<br>';
  h += 'L√§bivool a1: ' + fd(y1.tpMWh,1) + ' MWh (' + gv('g5') + ' ts√ºklit √ó ' + fd(r.rte*100,1) + '% RTE)<br>';
  h += 'Eluea ts√ºklid: ' + (gv('g5') * gv('i4')) + ' / ' + gv('i5') + (gv('g5')*gv('i4') > gv('i5') ? ' <b style="color:#ef5350">‚ö†Ô∏è √ºletab limiiti!</b>' : ' ‚úÖ');
  h += '</div>';

  h += '<h3>Finantsn√§itajad</h3><div class="sx"><table><thead><tr><th></th><th style="color:#00d4aa">Opt</th><th style="color:#42a5f5">Real</th><th style="color:#ef5350">Pess</th></tr></thead><tbody>';
  h += '<tr><td>NPV</td><td>' + fm(RO.npv) + '‚Ç¨</td><td>' + fm(r.npv) + '‚Ç¨</td><td>' + fm(RP.npv) + '‚Ç¨</td></tr>';
  h += '<tr><td>IRR</td><td>' + fp(RO.irr) + '</td><td>' + fp(r.irr) + '</td><td>' + fp(RP.irr) + '</td></tr>';
  h += '<tr><td>Payback</td><td>' + (RO.pb||'N/A') + 'a</td><td>' + (r.pb||'N/A') + 'a</td><td>' + (RP.pb||'N/A') + 'a</td></tr>';
  h += '<tr><td>ROI</td><td>' + fd(RO.roi,1) + '%</td><td>' + fd(r.roi,1) + '%</td><td>' + fd(RP.roi,1) + '%</td></tr>';
  h += '<tr><td>EBITDA</td><td>' + fm(RO.e15) + '‚Ç¨</td><td>' + fm(r.e15) + '‚Ç¨</td><td>' + fm(RP.e15) + '‚Ç¨</td></tr>';
  h += '</tbody></table></div>';

  h += '<h3>A1 tulu (Realistlik)</h3>';
  h += '<p>BESS: <b>' + fm(y1.bt||0) + '‚Ç¨</b> | PEJ: <b>' + fm(y1.pt||0) + '‚Ç¨</b> | Kokku: <b style="color:#00d4aa">' + fm(y1.rev||0) + '‚Ç¨</b></p>';
  if (r.npv > 0) {
    h += '<div class="hi"><b>‚úÖ POSITIIVNE:</b> NPV ' + fm(r.npv) + '‚Ç¨, IRR ' + fp(r.irr) + ', payback ' + (r.pb||'N/A') + 'a.</div>';
  } else {
    h += '<div class="ri"><b>‚ö†Ô∏è</b> NPV negatiivne (' + fm(r.npv) + '‚Ç¨).</div>';
  }
  h += '</div>';

  h += '<div class="rpt"><h2>‚ö†Ô∏è Riskid</h2>';
  h += '<div class="ri"><b>KRIITILINE:</b> Praegune tulukus ei garanteeri tulevikku.</div>';
  h += '<h3>A) Konkurents</h3><p>aFRR/mFRR hinnad v√µivad langeda 30-70%.</p>';
  h += '<h3>B) Regulatsioon</h3><p>Elering muudab reegleid pidevalt.</p>';
  h += '<h3>C) Tehnoloogia</h3><p>Uued akutehnoloogiad, hinnalangus 40-60%.</p>';
  h += '<h3>D) Volatiilsus</h3><p>Suuremad v√µrgu√ºhendused v√§hendavad hinnaerinevusi.</p>';
  h += '</div>';
  h += '<div class="disc"><h4>VASTUTUSE PIIRANG</h4><p>LOPLIK INVESTEERINGUOTSUS ON KLIENDI VASTUTUS.</p></div>';
  document.getElementById('out_rpt').innerHTML = h;
}

/* === PEJ ANALYSIS TAB === */
function showPEJAnalysis() {
  if (!PEJ.loaded) {
    document.getElementById('out_pej').innerHTML = '<div class="ctr"><p style="color:#6a7d90">Lae √ºles PEJ CSV fail Sisendite lehel</p></div>';
    return;
  }
  var mN = ['Jaan','Veebr','M√§rts','Apr','Mai','Juuni','Juuli','Aug','Sept','Okt','Nov','Dets'];
  var totalPlat = 0, totalClip = 0;
  for (var i = 0; i < 12; i++) { totalPlat += PEJ.monthlyPlateauH[i]; totalClip += PEJ.monthlyClipKWh[i]; }

  var h = '<div class="bx"><div class="bx-h">‚òÄÔ∏è PEJ reaalsed andmed ‚Äî ' + PEJ.filename + '</div><div class="bx-b">';
  h += '<p style="color:#6a7d90;font-size:11px">' + PEJ.address + ' | ' + PEJ.year + ' | ' + fm(PEJ.intervals) + ' intervalli</p>';

  /* Monthly bar chart */
  var mxM = Math.max.apply(null, PEJ.monthlyKWh);
  h += '<div style="margin:12px 0"><div class="lgd"><span><i style="background:#00d4aa"></i>Toodang</span><span><i style="background:#ffa726"></i>Clipping potentsiaal</span></div>';
  h += '<div class="bars" style="height:140px">';
  for (i = 0; i < 12; i++) {
    var pct = mxM > 0 ? PEJ.monthlyKWh[i] / mxM * 100 : 0;
    var cpct = mxM > 0 ? PEJ.monthlyClipKWh[i] / mxM * 100 : 0;
    h += '<div class="bgg"><div class="br" style="height:' + pct + '%;background:#00d4aa"></div>';
    if (cpct > 0.5) h += '<div class="br" style="height:' + cpct + '%;background:#ffa726"></div>';
    h += '</div>';
  }
  h += '</div><div class="xlb">';
  for (i = 0; i < 12; i++) h += '<span>' + mN[i] + '</span>';
  h += '</div></div>';

  /* Monthly table */
  h += '<div class="sx"><table class="dt"><thead><tr><th>Kuu</th><th>kWh</th><th>MWh</th><th>Tipp kW</th><th>Platoo h</th><th>Clipping kWh</th></tr></thead><tbody>';
  for (i = 0; i < 12; i++) {
    h += '<tr><td>' + mN[i] + '</td><td>' + fm(PEJ.monthlyKWh[i]) + '</td><td>' + fd(PEJ.monthlyKWh[i]/1000,1) + '</td><td>' + fd(PEJ.monthlyPeakKW[i],0) + '</td><td>' + fd(PEJ.monthlyPlateauH[i],1) + '</td><td>' + fm(PEJ.monthlyClipKWh[i]) + '</td></tr>';
  }
  h += '<tr class="tot"><td>Œ£</td><td>' + fm(PEJ.totalKWh) + '</td><td>' + fd(PEJ.totalKWh/1000,1) + '</td><td>' + fd(PEJ.peakKW,0) + '</td><td>' + fd(totalPlat,0) + '</td><td>' + fm(totalClip) + '</td></tr>';
  h += '</tbody></table></div>';

  /* Hourly profile */
  h += '<div style="margin-top:12px"><b style="font-size:11px;color:#6a7d90">TUNNIPROFIIL (keskmine kW)</b></div>';
  var mxH = Math.max.apply(null, PEJ.hourlyAvgKW);
  h += '<div class="bars" style="height:100px">';
  for (i = 0; i < 24; i++) {
    var hpct = mxH > 0 ? PEJ.hourlyAvgKW[i] / mxH * 100 : 0;
    h += '<div class="bgg"><div class="br" style="height:' + hpct + '%;background:' + (PEJ.hourlyAvgKW[i] >= gv('j1b')*1000*0.8 ? '#ffa726' : '#00d4aa') + '"></div></div>';
  }
  h += '</div><div class="xlb">';
  for (i = 0; i < 24; i++) h += '<span>' + (i<10?'0':'') + i + '</span>';
  h += '</div>';

  /* Clipping capture summary with SOC strategy */
  var socAt10 = gv('i9');
  var ec0_kwh = gv('i2') * gv('i7')/100 * gv('i8')/100 * 1000;
  var roomKWh = ec0_kwh * (1 - socAt10/100);
  var mClipDays = [0,0,6,12,14,10,12,10,10,4,0,0];
  var captured = 0;
  for (var ci2 = 0; ci2 < 12; ci2++) {
    if (PEJ.monthlyClipKWh[ci2] > 0 && mClipDays[ci2] > 0) {
      var avgDay = PEJ.monthlyClipKWh[ci2] / mClipDays[ci2];
      captured += Math.min(avgDay, roomKWh) * mClipDays[ci2];
    }
  }
  var capturePct = totalClip > 0 ? captured / totalClip * 100 : 0;

  h += '<div style="margin-top:12px;padding:12px;background:#1a2332;border-radius:8px">';
  h += '<b style="color:#ffa726">üîÜ Clipping Capture + SOC strateegia</b><br>';
  h += '<span style="font-size:11px;color:#8899aa">Paneelid: ' + (gv('j1')*1000) + ' kWp | Inverter: ' + (gv('j1b')*1000) + ' kW | Suhe: ' + fd(gv('j1')/gv('j1b'),2) + 'x</span><br>';
  h += '<span style="font-size:11px;color:#8899aa">Platoo: ' + fd(totalPlat,0) + ' h/a | Kadunud energia: ' + fm(totalClip) + ' kWh (' + fd(totalClip/1000,1) + ' MWh)</span><br>';
  h += '<div style="margin:8px 0;padding:8px;background:#0b1017;border-radius:6px;font-size:11px">';
  h += '<b style="color:#42a5f5">DA SOC strateegia:</b><br>';
  h += 'üåô √ñ√∂ 01-04h: lae BESS @ ~40 ‚Ç¨/MWh<br>';
  h += '‚òÄÔ∏è Hommik 07-09h: t√ºhjenda BESS @ ~128 ‚Ç¨/MWh (spread ~88 ‚Ç¨/MWh)<br>';
  h += '‚Üí <b>SOC kell 10:00: ' + socAt10 + '%</b> ‚Üí vaba ruum: <b>' + fm(roomKWh) + ' kWh</b><br>';
  h += 'üîÜ P√§ev 10-15h: PEJ clipping ‚Üí BESS laeb @ 0 ‚Ç¨/MWh<br>';
  h += 'üåÜ √ïhtu 17-21h: t√ºhjenda @ ~120-180 ‚Ç¨/MWh</div>';
  h += '<span style="font-size:12px;color:#00d4aa"><b>BESS-iga haaratav: ' + fm(captured) + ' kWh (' + fd(capturePct,1) + '% koguclippingust)</b></span><br>';
  if (capturePct < 90) {
    h += '<span style="font-size:10px;color:#ffa726">‚ö†Ô∏è Capture < 90%. ';
    h += 'Suurenda haaramist: v√§iksem SOC (praegu ' + socAt10 + '%) ';
    h += 'v√µi suurem aku mahtuvus (praegu ' + fm(ec0_kwh) + ' kWh eff.)</span>';
  } else {
    h += '<span style="font-size:10px;color:#00d4aa">‚úÖ Clipping capture optimaalne (' + fd(capturePct,1) + '%)</span>';
  }
  h += '</div>';

  h += '</div></div>';
  document.getElementById('out_pej').innerHTML = h;
}
</script>
</body>
</html>
